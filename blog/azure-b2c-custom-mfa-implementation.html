<!DOCTYPE html>
<html>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/azure-b2c-custom-mfa-implementation by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 10 Dec 2022 19:11:24 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>

    <!--- basic page needs
    ================================================== -->
    <meta charset="utf-8">

    
    <title>Azure B2C custom MFA implementation - Blog by Kalle Marjokorpi</title>
    <meta name="description" content="How to configure custom MFA implementation to Azure B2C. Azure MFA can be easily enabled but sometimes custom implementation is required.">
    <meta name="author" content="Kalle Marjokorpi">


    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="../css/base2b2c.css?dt=638062960289920963">
    <link rel="stylesheet" href="../css/vendor2b2c.css?dt=638062960289920963">
    <link rel="stylesheet" href="../css/main2b2c.css?dt=638062960289920963">
    <script src="../js/modernizr.js"></script>

    <script type="text/javascript">
        !function (T, l, y) { var S = T.location, k = "script", D = "instrumentationKey", C = "ingestionendpoint", I = "disableExceptionTracking", E = "ai.device.", b = "toLowerCase", w = "crossOrigin", N = "POST", e = "appInsightsSDK", t = y.name || "appInsights"; (y.name || T[e]) && (T[e] = t); var n = T[t] || function (d) { var g = !1, f = !1, m = { initialize: !0, queue: [], sv: "5", version: 2, config: d }; function v(e, t) { var n = {}, a = "Browser"; return n[E + "id"] = a[b](), n[E + "type"] = a, n["ai.operation.name"] = S && S.pathname || "_unknown_", n["ai.internal.sdkVersion"] = "javascript:snippet_" + (m.sv || m.version), { time: function () { var e = new Date; function t(e) { var t = "" + e; return 1 === t.length && (t = "0" + t), t } return e.getUTCFullYear() + "-" + t(1 + e.getUTCMonth()) + "-" + t(e.getUTCDate()) + "T" + t(e.getUTCHours()) + ":" + t(e.getUTCMinutes()) + ":" + t(e.getUTCSeconds()) + "." + ((e.getUTCMilliseconds() / 1e3).toFixed(3) + "").slice(2, 5) + "Z" }(), iKey: e, name: "Microsoft.ApplicationInsights." + e.replace(/-/g, "") + "." + t, sampleRate: 100, tags: n, data: { baseData: { ver: 2 } } } } var h = d.url || y.src; if (h) { function a(e) { var t, n, a, i, r, o, s, c, u, p, l; g = !0, m.queue = [], f || (f = !0, t = h, s = function () { var e = {}, t = d.connectionString; if (t) for (var n = t.split(";"), a = 0; a < n.length; a++) { var i = n[a].split("="); 2 === i.length && (e[i[0][b]()] = i[1]) } if (!e[C]) { var r = e.endpointsuffix, o = r ? e.location : null; e[C] = "https://" + (o ? o + "." : "") + "dc." + (r || "services.visualstudio.com") } return e }(), c = s[D] || d[D] || "", u = s[C], p = u ? u + "/v2/track" : d.endpointUrl, (l = []).push((n = "SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)", a = t, i = p, (o = (r = v(c, "Exception")).data).baseType = "ExceptionData", o.baseData.exceptions = [{ typeName: "SDKLoadFailed", message: n.replace(/\./g, "-"), hasFullStack: !1, stack: n + "\nSnippet failed to load [" + a + "] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: " + (S && S.pathname || "_unknown_") + "\nEndpoint: " + i, parsedStack: [] }], r)), l.push(function (e, t, n, a) { var i = v(c, "Message"), r = i.data; r.baseType = "MessageData"; var o = r.baseData; return o.message = 'AI (Internal): 99 message:"' + ("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) (" + n + ")").replace(/\"/g, "") + '"', o.properties = { endpoint: a }, i }(0, 0, t, p)), function (e, t) { if (JSON) { var n = T.fetch; if (n && !y.useXhr) n(t, { method: N, body: JSON.stringify(e), mode: "cors" }); else if (XMLHttpRequest) { var a = new XMLHttpRequest; a.open(N, t), a.setRequestHeader("Content-type", "application/json"), a.send(JSON.stringify(e)) } } }(l, p)) } function i(e, t) { f || setTimeout(function () { !t && m.core || a() }, 500) } var e = function () { var n = l.createElement(k); n.src = h; var e = y[w]; return !e && "" !== e || "undefined" == n[w] || (n[w] = e), n.onload = i, n.onerror = a, n.onreadystatechange = function (e, t) { "loaded" !== n.readyState && "complete" !== n.readyState || i(0, t) }, n }(); y.ld < 0 ? l.getElementsByTagName("head")[0].appendChild(e) : setTimeout(function () { l.getElementsByTagName(k)[0].parentNode.appendChild(e) }, y.ld || 0) } try { m.cookie = l.cookie } catch (p) { } function t(e) { for (; e.length;)!function (t) { m[t] = function () { var e = arguments; g || m.queue.push(function () { m[t].apply(m, e) }) } }(e.pop()) } var n = "track", r = "TrackPage", o = "TrackEvent"; t([n + "Event", n + "PageView", n + "Exception", n + "Trace", n + "DependencyData", n + "Metric", n + "PageViewPerformance", "start" + r, "stop" + r, "start" + o, "stop" + o, "addTelemetryInitializer", "setAuthenticatedUserContext", "clearAuthenticatedUserContext", "flush"]), m.SeverityLevel = { Verbose: 0, Information: 1, Warning: 2, Error: 3, Critical: 4 }; var s = (d.extensionConfig || {}).ApplicationInsightsAnalytics || {}; if (!0 !== d[I] && !0 !== s[I]) { var c = "onerror"; t(["_" + c]); var u = T[c]; T[c] = function (e, t, n, a, i) { var r = u && u(e, t, n, a, i); return !0 !== r && m["_" + c]({ message: e, url: t, lineNumber: n, columnNumber: a, error: i }), r }, d.autoExceptionInstrumented = !0 } return m }(y.cfg); function a() { y.onInit && y.onInit(n) } (T[t] = n).queue && 0 === n.queue.length ? (n.queue.push(a), n.trackPageView({})) : a() }(window, document, {
            src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", // The SDK URL Source
            // name: "appInsights", // Global SDK Instance name defaults to "appInsights" when not supplied
            // ld: 0, // Defines the load delay (in ms) before attempting to load the sdk. -1 = block page load and add to head. (default) = 0ms load after timeout,
            // useXhr: 1, // Use XHR instead of fetch to report failures (if available),
            crossOrigin: "anonymous", // When supplied this will add the provided value as the cross origin attribute on the script tag
            // onInit: null, // Once the application insights instance has loaded and initialized this callback function will be called with 1 argument -- the sdk instance (DO NOT ADD anything to the sdk.queue -- As they won't get called)
            cfg: { // Application Insights Configuration
                instrumentationKey: "5c788919-72be-4412-ae6b-74d2981b98bf"
            }
        });
    </script>

</head>
<body id="top">
   
    <!-- header
    ================================================== -->

    <!-- header
   ================================================== -->

<header class="s-header">

    <div class="header-logo">
        <a class="site-logo" href="../index.html"><img src="../images/logo2.png" alt="Homepage"></a>
    </div>

    

    <nav class="header-nav-wrap">

        <ul class="header-nav">


            <li class=""><a id="top-navigation-link-root" href="../index.html" title="">Home</a></li>

                <li id="top-navigation-link-about" class="smoothscroll"><a href="../about.html" title="">About me</a></li>

        </ul>
    </nav> <!-- end main-nav-wrap -->




    <a class="header-menu-toggle" href="#0"><span>Menu</span></a>

</header> <!-- end s-header -->



    

<!-- content
   ================================================== -->


    <article class="blog-single">

        <!-- page header/blog hero
    ================================================== -->

        
        <div class="page-header page-header--single page-hero" style=background-image:url(https://cdn.buttercms.com/KJllhG9TROeQq1A7x18Z)>

            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                                <a id="post-category-authentication" href="category/authentication.html">Authentication</a>
                                <a id="post-category-azure" href="category/azure.html">Azure</a>
                                <a id="post-category-azure-b2c" href="category/azure-b2c.html">Azure B2C</a>
                                <a id="post-category-mfa" href="category/mfa.html">MFA</a>
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        <a href="#0" title="">
                            Azure B2C custom MFA implementation
                        </a>
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">
17.04.2021 03:53                        </li>
                        <li class="author">
                            By
                            <span>Kalle Marjokorpi</span>
                        </li>
                    </ul>

                </article>
                
            </div>

        </div> <!-- end page-header -->

        <div class="row blog-content">
            <div class="col-full blog-content__main">

                <p><p>This blog post shows how to configure custom MFA implementation to Azure B2C with custom policies (SignIn). Azure MFA can be easily configured to the custom policies but sometimes custom implementation is required ex. if you want to use own service provider to deliver SMS based MFA events. Article doesn't cover details about the custom REST API implementation but overall implementation looks like this:</p>
<p><img src="https://cdn.buttercms.com/a4vzCM59SxuuUhibDZ1Q" alt="undefined" /></p>
<p></p>
<h2>Azure B2C custom policy configuration</h2>
<h3>1. User Journey configuration</h3>
<p><span style="font-family: sans-serif;">First configure a new step to your User Journey which starts MFA (SMS) process.</span></p>
<div>
<pre class="language-markup"><code>&lt;UserJourneys&gt;
    &lt;UserJourney Id="SignInWithMfa"&gt;
        &lt;OrchestrationSteps&gt;
            &lt;OrchestrationStep Order="1"&gt;&lt;/OrchestrationStep&gt;
            &lt;OrchestrationStep Order="2"&gt;&lt;/OrchestrationStep&gt;
            &lt;OrchestrationStep Order="3" Type="ClaimsExchange"&gt;
                &lt;ClaimsExchanges&gt;
                    &lt;!--Custom MFA (SMS) process starts--&gt;
                    &lt;ClaimsExchange Id="VerifyPhone" TechnicalProfileReferenceId="PhoneVerify-Profile" /&gt;
                &lt;/ClaimsExchanges&gt;
            &lt;/OrchestrationStep&gt;
            &lt;OrchestrationStep Order="4"&gt;&lt;/OrchestrationStep&gt;
        &lt;/OrchestrationSteps&gt;
    &lt;/UserJourney&gt;
&lt;/UserJourneys&gt;</code></pre>
<div>
<h3><span>2. Configure claims schema</span></h3>
<pre class="language-markup"><code>&lt;BuildingBlocks&gt;
    &lt;ClaimsSchema&gt;
       &lt;!--ReadOnlyPhoneNumber is shown in the Display Control (MFA)--&gt;
       &lt;ClaimType Id="ReadOnlyPhoneNumber"&gt;
            &lt;DisplayName&gt;Phone number&lt;/DisplayName&gt;
            &lt;DataType&gt;string&lt;/DataType&gt;
            &lt;Mask Type="Simple"&gt;XXX-XXX-&lt;/Mask&gt;
            &lt;UserHelpText&gt;Your mobile number&lt;/UserHelpText&gt;
            &lt;UserInputType&gt;Readonly&lt;/UserInputType&gt;
      &lt;/ClaimType&gt;
      &lt;!--StrongAuthenticationPhoneNumber is existing verified phone number--&gt;
      &lt;ClaimType Id="StrongAuthenticationPhoneNumber"&gt;
            &lt;DisplayName&gt;Phone Number&lt;/DisplayName&gt;
            &lt;DataType&gt;string&lt;/DataType&gt;
            &lt;Mask Type="Simple"&gt;XXX-XXX-&lt;/Mask&gt;
            &lt;UserHelpText&gt;Your telephone number&lt;/UserHelpText&gt;
      &lt;/ClaimType&gt;
      &lt;!--VerificationCode is shown in the Display Control (MFA)--&gt;
      &lt;ClaimType Id="VerificationCode"&gt;
            &lt;DisplayName&gt;Verification Code&lt;/DisplayName&gt;
            &lt;DataType&gt;string&lt;/DataType&gt;
            &lt;UserHelpText&gt;Enter your SMS verification code&lt;/UserHelpText&gt;
            &lt;UserInputType&gt;TextBox&lt;/UserInputType&gt;
      &lt;/ClaimType&gt;
      &lt;!--To whom code is sent--&gt;
      &lt;ClaimType Id="To"&gt;
        &lt;DataType&gt;string&lt;/DataType&gt;
        &lt;UserHelpText/&gt;
      &lt;/ClaimType&gt;
      &lt;!--User interface Culture--&gt;
      &lt;ClaimType Id="Culture"&gt;
        &lt;DisplayName&gt;Culture ID&lt;/DisplayName&gt;
        &lt;DataType&gt;string&lt;/DataType&gt;
      &lt;/ClaimType&gt;
      &lt;!--Actual verify endpoint status--&gt;
      &lt;ClaimType Id="StatusText"&gt;
        &lt;DisplayName&gt;Status from SMS code verify&lt;/DisplayName&gt;
        &lt;DataType&gt;string&lt;/DataType&gt;
      &lt;/ClaimType&gt;
      &lt;!--Expected verify endpoint status--&gt;
      &lt;ClaimType Id="ExpectedStatusText"&gt;
        &lt;DisplayName&gt;Static status for SMS code verify&lt;/DisplayName&gt;
        &lt;DataType&gt;string&lt;/DataType&gt;
      &lt;/ClaimType&gt;
      &lt;!--Length of the verification code--&gt;
      &lt;ClaimType Id="CodeLength"&gt;
        &lt;DataType&gt;string&lt;/DataType&gt;
        &lt;UserHelpText/&gt;
      &lt;/ClaimType&gt;
    &lt;/ClaimsSchema&gt;
&lt;/BuildingBlocks&gt;</code></pre>
<h3>3. Technical Profile for handling MFA process<br /><span></span></h3>
</div>
<div>
<div>
<div><span>This technical profile transforms existing phone number (User's AD profile) to read only field and initializes Display Control. Display control defines the UI for MFA functionality.<br /><br /></span></div>
</div>
<div>
<pre class="language-markup"><code>&lt;ClaimsProvider&gt;
    &lt;DisplayName&gt;Custom SMS provider&lt;/DisplayName&gt;
    &lt;TechnicalProfiles&gt;
        &lt;!--Custom MFA (SMS) technical profile--&gt;
        &lt;TechnicalProfile Id="PhoneVerify-Profile"&gt;
            &lt;DisplayName&gt;PhoneVerify-Profile&lt;/DisplayName&gt;
            &lt;Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" /&gt;
            &lt;Metadata&gt;
                &lt;Item Key="ContentDefinitionReferenceId"&gt;api.selfasserted&lt;/Item&gt;
            &lt;/Metadata&gt;
            &lt;InputClaimsTransformations&gt;
                &lt;!--This transforms existing phone number to read only claim--&gt;
                &lt;InputClaimsTransformation ReferenceId="CopyStrongAuthenticationPhoneNumberToReadOnlyPhoneNumber" /&gt;
            &lt;/InputClaimsTransformations&gt;
            &lt;DisplayClaims&gt;
                &lt;!--Custom Display Control which shows existing phone number and verification code input field--&gt;
                &lt;DisplayClaim DisplayControlReferenceId="PhoneVerificationControlForSignIn" /&gt;
            &lt;/DisplayClaims&gt;
            &lt;OutputClaims&gt;
                &lt;!--List of claims which will be returned to the next orchestration step--&gt;
                &lt;OutputClaim ClaimTypeReferenceId="StrongAuthenticationPhoneNumber" PartnerClaimType="ReadOnlyPhoneNumber" /&gt;
            &lt;/OutputClaims&gt;
            &lt;UseTechnicalProfileForSessionManagement ReferenceId="SM-MFA" /&gt;          
        &lt;/TechnicalProfile&gt;
    &lt;/TechnicalProfiles&gt;
&lt;/ClaimsProvider&gt;</code></pre>
<div>
<h3><span>4. Claims transformation</span></h3>
<div>
<div><span><strong>CopyStrongAuthenticationPhoneNumberToReadOnly </strong>transformation method uses "FormatStringClaim" method to copy existing phone number to read only field which is used in the Display Control. <strong>VerifyStatus </strong>transformation verifies that verify API call has returned the expected status.<br /><br /></span></div>
</div>
</div>
<div>
<pre class="language-markup"><code>&lt;BuildingBlocks&gt;
    &lt;ClaimsTransformations&gt;
        &lt;!--Copies StrongAuthenticationPhoneNumber claim value to ReadOnlyPhoneNumber--&gt;
        &lt;ClaimsTransformation Id="CopyStrongAuthenticationPhoneNumberToReadOnlyPhoneNumber" TransformationMethod="FormatStringClaim"&gt;
            &lt;InputClaims&gt;
                &lt;InputClaim ClaimTypeReferenceId="StrongAuthenticationPhoneNumber" TransformationClaimType="inputClaim" /&gt;
            &lt;/InputClaims&gt;
            &lt;InputParameters&gt;
                &lt;InputParameter Id="stringFormat" DataType="string" Value="{0}" /&gt;
            &lt;/InputParameters&gt;
            &lt;OutputClaims&gt;
                &lt;OutputClaim ClaimTypeReferenceId="ReadOnlyPhoneNumber" TransformationClaimType="outputClaim" /&gt;
            &lt;/OutputClaims&gt;          
        &lt;/ClaimsTransformation&gt;
        &lt;!--Checks that verify request is approved--&gt;
        &lt;ClaimsTransformation Id="VerifyStatus" TransformationMethod="AssertStringClaimsAreEqual"&gt;
          &lt;InputClaims&gt;
            &lt;InputClaim ClaimTypeReferenceId="StatusText" TransformationClaimType="inputClaim1" /&gt;
            &lt;InputClaim ClaimTypeReferenceId="ExpectedStatusText" TransformationClaimType="inputClaim2" /&gt;
          &lt;/InputClaims&gt;
          &lt;InputParameters&gt;
            &lt;InputParameter Id="stringComparison" DataType="string" Value="ordinalIgnoreCase" /&gt;
          &lt;/InputParameters&gt;
        &lt;/ClaimsTransformation&gt;
    &lt;/ClaimsTransformations&gt;
&lt;/BuildingBlocks&gt;</code></pre>
</div>
<h3>5. MFA user interface</h3>
<div>
<div><span>Display Control presents phone number (read only field) and verification code input field where verification code from SMS is inputted. VerificationControl based Display Control has Send and Verify Code actions which call custom REST API.<br /><br /></span></div>
</div>
<pre class="language-markup"><code>&lt;DisplayControls&gt;
        &lt;!--MFA verification display control--&gt;
       &lt;DisplayControl Id="PhoneVerificationControlForSignIn" UserInterfaceControlType="VerificationControl"&gt;
            &lt;InputClaims&gt;
                &lt;!--Incoming claims--&gt;
                &lt;InputClaim ClaimTypeReferenceId="ReadOnlyPhoneNumber" /&gt;
            &lt;/InputClaims&gt;          
            &lt;DisplayClaims&gt;
                &lt;!--Fields which are shown in the UI--&gt;
                &lt;DisplayClaim ClaimTypeReferenceId="ReadOnlyPhoneNumber" Required="true" /&gt;
                &lt;DisplayClaim ClaimTypeReferenceId="VerificationCode" ControlClaimType="VerificationCode" Required="true" /&gt;
            &lt;/DisplayClaims&gt;
            &lt;OutputClaims&gt;
                &lt;!--Outgoing claims--&gt;
                &lt;OutputClaim ClaimTypeReferenceId="StrongAuthenticationPhoneNumber" /&gt;
            &lt;/OutputClaims&gt;
            &lt;Actions&gt;
            &lt;Action Id="SendCode"&gt;
                &lt;ValidationClaimsExchange&gt;
                    &lt;!--Execute Send REST API call--&gt;
                    &lt;ValidationClaimsExchangeTechnicalProfile TechnicalProfileReferenceId="SendMfaRequest" /&gt;
                &lt;/ValidationClaimsExchange&gt;
            &lt;/Action&gt;
            &lt;Action Id="VerifyCode"&gt;
                &lt;ValidationClaimsExchange&gt;
                    &lt;!--Execute Verify REST API call--&gt;
                    &lt;ValidationClaimsExchangeTechnicalProfile TechnicalProfileReferenceId="VerifyMfaRequest" /&gt;
                &lt;/ValidationClaimsExchange&gt;
            &lt;/Action&gt;
            &lt;/Actions&gt;
      &lt;/DisplayControl&gt;
&lt;/DisplayControls&gt;</code></pre>
<p>With this configuration send verification code UI looks this. Clicking the "Send verification code" button executes REST API call which is configuration in the next step:</p>
<p><span><img src="https://cdn.buttercms.com/9XCKCeTR8WZ88wdgJte1" alt="undefined" /></span></p>
<p>After successful send operation, verification code input field is shown like this:</p>
<p><img src="https://cdn.buttercms.com/FaFaMZD5QGCdUT22v3t6" alt="undefined" /></p>
<h3><span style="font-weight: 600; font-family: sans-serif;">6. REST API call for sending and verifying the code</span></h3>
<div>
<p>This technical profile declares your API endpoints for sending and verifying the code.<br /><span></span></p>
<div>
<pre class="language-markup"><code>&lt;ClaimsProvider&gt;
      &lt;DisplayName&gt;Custom MFA REST APIs&lt;/DisplayName&gt;
      &lt;TechnicalProfiles&gt;
            &lt;TechnicalProfile Id="SendMfaRequest"&gt;
            &lt;DisplayName&gt;Custom MFA (SMS) send implementation&lt;/DisplayName&gt;
            &lt;Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" /&gt;
            &lt;Metadata&gt;
                &lt;!--Your REST endpoint URL--&gt;
                &lt;Item Key="ServiceUrl"&gt;https://myapi.fi/api/send&lt;/Item&gt;
                &lt;Item Key="SendClaimsIn"&gt;Body&lt;/Item&gt;
                &lt;!--Set AuthenticationType to Basic or ClientCertificate in production environments --&gt;
                &lt;Item Key="AuthenticationType"&gt;Basic&lt;/Item&gt;
            &lt;/Metadata&gt;
            &lt;CryptographicKeys&gt;
                &lt;!--Basic authentication username and password will be fetched from the B2C Policy keys--&gt;
                &lt;Key Id="BasicAuthenticationUsername" StorageReferenceId="B2C_1A_ApiUsername" /&gt;
                &lt;Key Id="BasicAuthenticationPassword" StorageReferenceId="B2C_1A_ApiPassword" /&gt;
            &lt;/CryptographicKeys&gt;
            &lt;InputClaims&gt;
                &lt;!-- Claims sent to your REST API --&gt;
                &lt;InputClaim ClaimTypeReferenceId="ReadOnlyPhoneNumber" PartnerClaimType="To"/&gt;
                &lt;InputClaim ClaimTypeReferenceId="Culture" DefaultValue="{Culture:RFC5646}"/&gt;
                &lt;InputClaim ClaimTypeReferenceId="Ip" DefaultValue="{Context:IPAddress}"/&gt;            
                &lt;InputClaim ClaimTypeReferenceId="CodeLength" DefaultValue="6"/&gt;            
            &lt;/InputClaims&gt;
            &lt;OutputClaims&gt;
                &lt;!-- Claims parsed from your REST API --&gt;
            &lt;/OutputClaims&gt;
            &lt;UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" /&gt;
            &lt;/TechnicalProfile&gt;
      &lt;/TechnicalProfiles&gt;
      &lt;TechnicalProfile Id="VerifyMfaRequest"&gt;
          &lt;DisplayName&gt;Custom MFA (SMS) verify implementation&lt;/DisplayName&gt;
          &lt;Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" /&gt;
          &lt;Metadata&gt;
            &lt;!--Your REST endpoint URL--&gt;
            &lt;Item Key="ServiceUrl"&gt;https://myapi.fi/api/verify&lt;/Item&gt;
            &lt;Item Key="SendClaimsIn"&gt;Body&lt;/Item&gt;
            &lt;!--Set AuthenticationType to Basic or ClientCertificate in production environments --&gt;
            &lt;Item Key="AuthenticationType"&gt;Basic&lt;/Item&gt;
          &lt;/Metadata&gt;
          &lt;CryptographicKeys&gt;
            &lt;!--Basic authentication username and password will be fetched from the B2C Policy keys--&gt;
            &lt;Key Id="BasicAuthenticationUsername" StorageReferenceId="B2C_1A_ApiUsername" /&gt;
            &lt;Key Id="BasicAuthenticationPassword" StorageReferenceId="B2C_1A_ApiPassword" /&gt;
          &lt;/CryptographicKeys&gt;
          &lt;InputClaims&gt;
            &lt;InputClaim ClaimTypeReferenceId="ReadOnlyPhoneNumber" PartnerClaimType="To"/&gt;
            &lt;InputClaim ClaimTypeReferenceId="VerificationCode" PartnerClaimType="Code"/&gt;
            &lt;InputClaim ClaimTypeReferenceId="Ip" DefaultValue="{Context:IPAddress}"/&gt;
            &lt;InputClaim ClaimTypeReferenceId="Culture" DefaultValue="{Culture:RFC5646}"/&gt;
          &lt;/InputClaims&gt;
          &lt;OutputClaims&gt;
            &lt;!--Expected status from the REST API is "OK"--&gt;
            &lt;OutputClaim ClaimTypeReferenceId="ExpectedStatusText" DefaultValue="OK" /&gt;
            &lt;!--Actual status--&gt;
            &lt;OutputClaim ClaimTypeReferenceId="StatusText"/&gt;
          &lt;/OutputClaims&gt;
          &lt;OutputClaimsTransformations&gt;
            &lt;!--Verify that actual and expected status are same--&gt;
            &lt;OutputClaimsTransformation ReferenceId="VerifyStatus"/&gt;
          &lt;/OutputClaimsTransformations&gt;
          &lt;UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" /&gt;
     &lt;/TechnicalProfile&gt;
&lt;/ClaimsProvider&gt;</code></pre>
</div>
<div><span></span></div>
<h3><span>7. Localization</span></h3>
<p><span>With LocalizedString element you can localize DisplayControl and ClaimType texts.<br /></span></p>
<div>
<pre class="language-markup"><code>&lt;LocalizedResources Id="api.localaccountsignup.en"&gt;  
    &lt;LocalizedStrings&gt;
        &lt;LocalizedString ElementType="ClaimType" ElementId="ReadOnlyPhoneNumber" StringId="DisplayName"&gt;Phone number&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="ClaimType" ElementId="VerificationCode" StringId="DisplayName"&gt;Verify code&lt;/LocalizedString&gt; 
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="intro_msg"&gt;&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="success_send_code_msg"&gt;Verification code has been sent to&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="failure_send_code_msg"&gt;Cannot use MFA service, please try again later.&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="success_verify_code_msg"&gt;Phone number is verified. You can now continue.&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="failure_verify_code_msg"&gt;Cannot use MFA service, please try again later.&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="but_send_code"&gt;Send code&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="but_verify_code"&gt;Verify code&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="but_send_new_code"&gt;Send new code&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="DisplayControl" ElementId="PhoneVerificationControlForSignIn" StringId="but_change_claims"&gt;Change phone number&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="ErrorMessage" StringId="DefaultUserMessageIfRequestFailed"&gt;Failed to establish connection to restful service end point.&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="ErrorMessage" StringId="UserMessageIfCircuitOpen"&gt;Unable to connect to the restful service end point.&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="ErrorMessage" StringId="UserMessageIfDnsResolutionFailed"&gt;Failed to resolve the hostname of the restful service endpoint.&lt;/LocalizedString&gt;
        &lt;LocalizedString ElementType="ErrorMessage" StringId="UserMessageIfRequestTimeout"&gt;Failed to establish connection to restful service end point within timeout limit.&lt;/LocalizedString&gt;
    &lt;/LocalizedStrings&gt;
&lt;/LocalizedResources&gt;</code></pre>
</div>
<div></div>
<div><span>That's it, now the custom MFA functionality is done from the custom policy perspective!</span></div>
<div><span style="font-weight: 600;"></span></div>
<h2><span style="font-weight: 600;">Other things</span><br /><span></span></h2>
<h3><span>REST API validation errors</span></h3>
<p><span>Check <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/custom-policy-rest-api-claims-validation#prepare-a-rest-api-endpoint" rel="follow">this article</a>. According the documentation: "</span>If the validation failed, the REST API must return an HTTP 409 (Conflict), with the userMessage JSON element. The IEF expects the userMessage claim that the REST API returns. This claim will be presented as a string to the user if the validation fails."<span></span></p>
<pre class="language-undefined"><code>{
    "version": "1.0.1",
    "status": 409,
    "userMessage": "Code is expired."
}</code></pre>
<p>UI shows the validation error like this:</p>
<p><img src="https://cdn.buttercms.com/DrROjSgxTc2dP7WPnRqc" alt="undefined" /></p>
<h3><span>Phone number change button</span></h3>
<p><span>By default VerificationControl has the functionality to change delivery channel address where code is sent to. Delivery channel can be ex. a phone number or an email address. In our case this is not a working option because our phone number field is in read only mode. </span><span>Only way to hide this "Change" button was to use CSS. I didn't find any other ways to handle this.</span></p>
<p><span><img src="https://cdn.buttercms.com/4Na5GtNrT2G6VW2F6ljC" alt="undefined" /></span></p>
<p><span>I verified that if you remove the read-only attribute from the field by using Developer tools you cannot sent the verification code to the other number than which is configured to the User's AD profile.</span></p>
<p><span><img src="https://cdn.buttercms.com/jVy6u8PRbeHFwhc4wAJA" alt="undefined" /></span></p>
<div><span></span></div>
<div><span></span></div>
</div>
</div>
</div>
</div></p>

                <h2>Comments</h2>
                                    
                <div id="cusdis_thread"
                  data-host="https://cusdis.com/"
                  data-app-id="86620953-7757-4f01-94f2-bfb88caff8a4"
                  data-page-id="azure-b2c-custom-mfa-implementation"
                  data-page-url="azure-b2c-custom-mfa-implementation.html"
                  data-page-title="Azure B2C custom MFA implementation">
                <script src="https://cusdis.com/js/cusdis.es.js"></script>

                <div class="blog-content__pagenav">
                    <div class="blog-content__nav">
                            <div class="blog-content__prev">
                                <a id="post-previous-apple-health-data-conversion-to-fhir-observation" href="apple-health-data-conversion-to-fhir-observation.html" rel="prev">
                                    <span>Previous Post</span>
                                    Apple Health CDA data conversion to FHIR with Handlebar engine
                                </a>
                            </div>
                            <div class="blog-content__next">
                                <a id="post-next-how-to-minimize-blog-hosting-costs" href="how-to-minimize-blog-hosting-costs.html" rel="next">
                                    <span>Next Post</span>
                                    Minimizing the blog hosting costs
                                </a>
                            </div>
                        </div>


                    <div class="blog-content__all">
                        <a href="../index.html" class="btn btn--primary">
                            View All Post
                        </a>
                    </div>
                </div>

            </div><!-- end blog-content__main -->
        </div> <!-- end blog-content -->

    </article>



    

<!-- footer
    ================================================== -->
<footer>
    <div class="row">
        <div class="col-full">

            <div class="footer-logo">
                <a class="footer-site-logo" href="#0"><img src="../images/name.png" alt="Homepage"></a>
            </div>

            <ul class="footer-social">
                <li>
                    <a href="https://www.twitter.com/kmarjok">
                        <i class="im im-twitter" aria-hidden="true"></i>
                        <span>Twitter</span>
                    </a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/kallemarjokorpi">
                        <i class="im im-linkedin" aria-hidden="true"></i>
                        <span>Linkedin</span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/kalleantero">
                        <i class="im im-github" aria-hidden="true"></i>
                        <span>Github</span>
                    </a>
                </li>
            </ul>

        </div>
    </div>

    <div class="row footer-bottom">

        <div class="col-twelve">
            <div class="copyright">
                <span>Copyright Kalle Marjokorpi 2022</span>
                <span>Design by <a href="http://www.styleshout.com/">styleshout</a></span>
                <span>Content management by <a href="http://www.buttercms.com/">Headless ButterCMS</a></span>

            </div>

        </div>

    </div> <!-- end footer-bottom -->

</footer> <!-- end footer -->
   
    <!-- Java Script
     ================================================== -->

    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/plugins.js"></script>
    <script src="../js/main.min.js"></script>
    
    
    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "cac9fd24c1c04b6d9984ea31685b0414"}'></script><!-- End Cloudflare Web Analytics -->       

</body>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/azure-b2c-custom-mfa-implementation by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 10 Dec 2022 19:11:27 GMT -->
</html>
