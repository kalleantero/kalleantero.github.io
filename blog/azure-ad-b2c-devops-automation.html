<!DOCTYPE html>
<html>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/azure-ad-b2c-devops-automation by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 24 Apr 2021 13:42:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>

    <!--- basic page needs
    ================================================== -->
    <meta charset="utf-8">

    
    <title>Azure AD B2C DevOps automation - Blog by Kalle Marjokorpi</title>
    <meta name="description" content="This blob post describes one example how automate Azure B2C custom policy deployment to different environments.">
    <meta name="author" content="Kalle Marjokorpi">


    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/vendor.css">
    <link rel="stylesheet" href="../css/main.css">

    <script src="../js/modernizr.js"></script>
    <script src="../js/pace.min.js"></script>

    <script type="text/javascript">!function(T,l,y){var S=T.location,u="script",k="instrumentationKey",D="ingestionendpoint",C="disableExceptionTracking",E="ai.device.",I="toLowerCase",b="crossOrigin",w="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"4",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[I](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,p,l,u;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][I]()]=i[1])}if(!e[D]){var r=e.endpointsuffix,o=r?e.location:null;e[D]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[k]||d[k]||"",p=s[D],l=p?p+"/v2/track":config.endpointUrl,(u=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=l,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),u.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,l)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:w,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(w,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(u,l))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(u);n.src=h;var e=y[b];return!e&&""!==e||"undefined"==n[b]||(n[b]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(u)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[C]&&!0!==s[C]){method="onerror",t(["_"+method]);var c=T[method];T[method]=function(e,t,n,a,i){var r=c&&c(e,t,n,a,i);return!0!==r&&m["_"+method]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);(T[t]=n).queue&&0===n.queue.length&&n.trackPageView({})}(window,document,{
src: "https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js",
cfg: { 
    connectionString: 'InstrumentationKey=ebdfbae8-ec79-4f33-b5c3-ad05861ae331;IngestionEndpoint=https://westeurope-5.in.applicationinsights.azure.com/'
}});
    </script>
</head>
<body id="top">
   
    <!-- header
    ================================================== -->

    
        <!-- header
   ================================================== -->

<header class="s-header">

    <div class="header-logo">
        <a class="site-logo" href="../index.html"><img src="../images/logo2.png" alt="Homepage"></a>
    </div>

    

    <nav class="header-nav-wrap">

        <ul class="header-nav">


            <li class="current"><a id="top-navigation-link-root" href="../index.html" title="">Home</a></li>

                <li id="top-navigation-link-about" class="smoothscroll"><a href="../about.html" title="">About me</a></li>

        </ul>
    </nav> <!-- end main-nav-wrap -->




    <a class="header-menu-toggle" href="#0"><span>Menu</span></a>

</header> <!-- end s-header -->


    

    

<!-- content
   ================================================== -->


    <article class="blog-single">

        <!-- page header/blog hero
    ================================================== -->

        
        <div class="page-header page-header--single page-hero" style=background-image:url(https://cdn.buttercms.com/f1MS4DSTde3ZO7lGyg1Q)>

            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                                <a id="post-category-automation" href="category/automation.html">Automation</a>
                                <a id="post-category-azure-b2c" href="category/azure-b2c.html">Azure B2C</a>
                                <a id="post-category-azure-devops" href="category/azure-devops.html">Azure DevOps</a>
                                <a id="post-category-powershell" href="category/powershell.html">PowerShell</a>
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        <a href="#0" title="">
                            How to automate Azure B2C custom policy deployment?
                        </a>
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">
25.02.2021 22:00                        </li>
                        <li class="author">
                            By
                            <span>Kalle Marjokorpi</span>
                        </li>
                    </ul>

                </article>
                
            </div>

        </div> <!-- end page-header -->

        <div class="row blog-content">
            <div class="col-full blog-content__main">

                <p><p>When you're using Azure AD B2C custom policies you most probably have created TrustedFrameworkBase.xml, TrustedFrameworkExtensions.xml and ex. SignUpOrSignIn.xml files. These files always contains environment specific references which are required to change during the deployment process.&nbsp;</p>
<p>Microsoft docs has an article <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/deploy-custom-policies-devops" rel="follow">how to deploy custom policies with Azure Pipelines</a> but article does not cover how to handle environment specific variables in custom policy files. This blob post describes one example how automate Azure B2C custom policy deployment to different environments.&nbsp;</p>
<h2>Environment specific settings</h2>
<h3>Common environment specific settings in custom policy XML files</h3>
<p><strong>TrustFrameworkPolicy </strong>attributes are declared in every custom policy file so <strong>TenantId </strong>and <strong>PublicPolicyUri </strong>attributes are required to change.</p>
<pre class="language-markup"><code>&lt;TrustFrameworkPolicy
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06"
  PolicySchemaVersion="0.3.0.0"
  TenantId="[CHANGE-THIS].onmicrosoft.com"
  PolicyId="B2C_1A_reset"
  PublicPolicyUri="http://[CHANGE-THIS].onmicrosoft.com/B2C_1A_reset"
  DeploymentMode="Production"
  UserJourneyRecorderEndpoint="urn:journeyrecorder:applicationinsights"&gt;</code></pre>
<p>Also <strong>BasePolicy </strong>element has <strong>TenantId </strong>child node which value is required to change.</p>
<pre class="language-markup"><code>&lt;BasePolicy&gt;
    &lt;TenantId&gt;[CHANGE-THIS].onmicrosoft.com&lt;/TenantId&gt;
    &lt;PolicyId&gt;B2C_1A_TrustFrameworkExtensions&lt;/PolicyId&gt;
&lt;/BasePolicy&gt;</code></pre>
<h3>UserJourney file specific settings (ex. SignUpOrSignIn.xml)</h3>
<p>If you're using Application Insight integration then <strong>InstrumentationKey </strong>attribute value is required to change which is declared in <strong>JourneyInsights </strong>element. Also <strong>DeveloperMode </strong>value must be changed to Production in Production environment.</p>
<pre class="language-markup"><code>&lt;UserJourneyBehaviors&gt;
      &lt;SingleSignOn Scope="Policy" /&gt;
      &lt;JourneyInsights TelemetryEngine="ApplicationInsights" InstrumentationKey="[CHANGE-THIS]" DeveloperMode="Production" ClientEnabled="true" ServerEnabled="true" TelemetryVersion="1.0.0" /&gt;
    &lt;/UserJourneyBehaviors&gt;</code></pre>
<h3>TrustFrameworkExtensions file specific settings</h3>
<p>Custom page layouts (=html files) are located to the blob storage so <strong>LoadUri </strong>is required to change.</p>
<pre class="language-markup"><code>&lt;ContentDefinition Id="api.signuporsignin"&gt;
        &lt;LoadUri&gt;https://[CHANGE-THIS].blob.core.windows.net/pagelayouts/{Culture:RFC5646}/unified.html&lt;/LoadUri&gt;
        &lt;RecoveryUri&gt;~/common/default_page_error.html&lt;/RecoveryUri&gt;
        &lt;DataUri&gt;urn:com:microsoft:aad:b2c:elements:unifiedssp:1.0.0&lt;/DataUri&gt;
        &lt;Metadata&gt;
          &lt;Item Key="DisplayName"&gt;Signin and Signup&lt;/Item&gt;
        &lt;/Metadata&gt;
        &lt;LocalizedResourcesReferences MergeBehavior="Prepend"&gt;
          &lt;LocalizedResourcesReference Language="en" LocalizedResourcesReferenceId="api.signuporsignin.en" /&gt;
          &lt;LocalizedResourcesReference Language="fi" LocalizedResourcesReferenceId="api.signuporsignin.fi" /&gt;
        &lt;/LocalizedResourcesReferences&gt;
      &lt;/ContentDefinition&gt;</code></pre>
<p>If you're using external IDP providers or API endpoint you have to change at least URL's inside the <strong>ClaimsProvider </strong>element.</p>
<pre class="language-markup"><code>&lt;ClaimsProvider&gt;
      &lt;Domain&gt;[CHANGE-THIS]&lt;/Domain&gt;
      &lt;DisplayName&gt;Third party IDP&lt;/DisplayName&gt;
      &lt;TechnicalProfiles&gt;
        &lt;TechnicalProfile Id="IDP-OAUTH"&gt;
          &lt;DisplayName&gt;IDP&lt;/DisplayName&gt;
          &lt;Protocol Name="OpenIdConnect" /&gt;
          &lt;Metadata&gt;
            &lt;Item Key="ProviderName"&gt;IDP&lt;/Item&gt;
            &lt;Item Key="METADATA"&gt;https://[CHANGE-THIS]/.well-known/openid-configuration&lt;/Item&gt;
            &lt;Item Key="ValidTokenIssuerPrefixes"&gt;https://[CHANGE-THIS]&lt;/Item&gt;
            &lt;Item Key="IdTokenAudience"&gt;services.clientId&lt;/Item&gt;
            &lt;Item Key="DiscoverMetadataByTokenIssuer"&gt;true&lt;/Item&gt;
            &lt;Item Key="response_types"&gt;code&lt;/Item&gt;
            &lt;Item Key="response_mode"&gt;form_post&lt;/Item&gt;
            &lt;Item Key="scope"&gt;openid given_name family_name name phone_number email address&lt;/Item&gt;
            &lt;Item Key="HttpBinding"&gt;POST&lt;/Item&gt;
            &lt;Item Key="UsePolicyInRedirectUri"&gt;false&lt;/Item&gt;
            &lt;Item Key="client_id"&gt;services.clientId&lt;/Item&gt;
            &lt;Item Key="SingleLogoutEnabled"&gt;true&lt;/Item&gt;
          &lt;/Metadata&gt;</code></pre>
<h2>How to handle environment specific custom policy configuration files?</h2>
<h3>Create base custom policy template files</h3>
<p>1. Create the following base custom policy template files to another folder in your solution structure</p>
<ul>
<li>BaseTemplates\BASE-SignUpOrSignIn.xml</li>
<li>BaseTemplates\BASE-TrustFrameworkBase.xml</li>
<li>BaseTemplates\BASE-TrustFrameworkExtensions.xml</li>
</ul>
<p>2. Add placeholders {PLACEHOLDER} to the BASE template files to places which values are environment specific and should be changed</p>
<pre class="language-markup"><code>&lt;TrustFrameworkPolicy
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06"
  PolicySchemaVersion="0.3.0.0"
  TenantId="{B2CTENANT}.onmicrosoft.com"
  PolicyId="B2C_1A_{B2CENVIRONMENT}_signup_signin"
  PublicPolicyUri="http://{B2CTENANT}.onmicrosoft.com/B2C_1A_signup_signin"
  DeploymentMode="{DEPLOYMENTMODE}"
  UserJourneyRecorderEndpoint="urn:journeyrecorder:applicationinsights"&gt;</code></pre>
<p>&nbsp;3. Implement PowerShell script which replace placeholders with real environment specific values and creates environment specific template files</p>
<ul>
<li>Dev\Dev-SignUpOrSignIn.xml</li>
<li>Dev\Dev-TrustFrameworkBase.xml</li>
<li>Dev\Dev-TrustFrameworkExtensions.xml</li>
<li>Test\Test-SignUpOrSignIn.xml</li>
<li>Test\Test-TrustFrameworkBase.xml</li>
<li>Test\Test-TrustFrameworkExtensions.xml</li>
<li>Prod\Prod-SignUpOrSignIn.xml</li>
<li>Prod\Prod-TrustFrameworkBase.xml</li>
<li>Prod\Prod-TrustFrameworkExtensions.xml</li>
</ul>
<p>Creation of these environment specific files using PowerShell is also possible directly from the Azure DevOps Build Pipeline. When you're using this approach you can retrieve environment specific values directly from Azure DevOps. Nothing sensitive information should not be saved to the custom policy files in any circumstances. This example uses approach where environment specific values (not sensitive information) are available in the PowerShell variables. This enables that environment specific files are saved to the source control so version history is always available.</p>
<h2>How to automate deployment by using Azure DevOps?</h2>
<p>&nbsp;1. Create Upload policy PowerShell script and store it to source control. Follow the example in <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/deploy-custom-policies-devops" rel="follow">here.</a><br />&nbsp;2. Configure Build Pipeline using ex. YAML to create Artifact<br />&nbsp;3. Create Release Pipeline with the following steps:</p>
<ul>
<li>Create AZCopy task to upload image files to Blob storage</li>
<li>Create AZCopy task to upload style files to Blob storage</li>
<li>Create AZCopy task to upload page layouts files to Blob storage</li>
<li>Create PowerShell task to execute upload policy script which was created in the first step</li>
</ul>
<h2>Overall picture how the automation works</h2>
<p><img src="https://cdn.buttercms.com/x7ham5DZSKm5YgqLaHSx" alt="undefined" /></p>
<p></p>
<p></p></p>

                <div class="blog-content__pagenav">
                    <div class="blog-content__nav">
                            <div class="blog-content__prev">
                                <a id="post-previous-azure-b2c-custom-policies-and-federated-authentication" href="azure-b2c-custom-policies-and-federated-authentication.html" rel="prev">
                                    <span>Previous Post</span>
                                    Key findings and learnings of Azure AD B2C custom policy configuration with federated authentication
                                </a>
                            </div>
                            <div class="blog-content__next">
                                <a id="post-next-export-apple-health-data-to-azure-api-for-fhir" href="export-apple-health-data-to-azure-api-for-fhir.html" rel="next">
                                    <span>Next Post</span>
                                    How to export Apple Health data to Azure API for FHIR?
                                </a>
                            </div>
                        </div>


                    <div class="blog-content__all">
                        <a href="../index.html" class="btn btn--primary">
                            View All Post
                        </a>
                    </div>
                </div>

            </div><!-- end blog-content__main -->
        </div> <!-- end blog-content -->

    </article>



    
        

<!-- footer
    ================================================== -->
<footer>
    <div class="row">
        <div class="col-full">

            <div class="footer-logo">
                <a class="footer-site-logo" href="#0"><img src="../images/name.png" alt="Homepage"></a>
            </div>

            <ul class="footer-social">
                <li>
                    <a href="https://www.twitter.com/kmarjok">
                        <i class="im im-twitter" aria-hidden="true"></i>
                        <span>Twitter</span>
                    </a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/kallemarjokorpi">
                        <i class="im im-linkedin" aria-hidden="true"></i>
                        <span>Linkedin</span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/kalleantero">
                        <i class="im im-github" aria-hidden="true"></i>
                        <span>Github</span>
                    </a>
                </li>
            </ul>

        </div>
    </div>

    <div class="row footer-bottom">

        <div class="col-twelve">
            <div class="copyright">
                <span>Copyright Kalle Marjokorpi 2021</span>
                <span>Design by <a href="http://www.styleshout.com/">styleshout</a></span>
                <span>Content management by <a href="http://www.buttercms.com/">Headless ButterCMS</a></span>

            </div>

        </div>

    </div> <!-- end footer-bottom -->

</footer> <!-- end footer -->
    


    <div id="preloader">
        <div id="loader"></div>
    </div>

    <!-- Java Script
     ================================================== -->
    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/plugins.js"></script>
    <script src="../js/main.min.js"></script>
    
    
    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "cac9fd24c1c04b6d9984ea31685b0414"}'></script><!-- End Cloudflare Web Analytics -->

</body>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/azure-ad-b2c-devops-automation by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 24 Apr 2021 13:42:33 GMT -->
</html>
