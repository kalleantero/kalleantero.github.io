<!DOCTYPE html>
<html class="no-js" lang="en">

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/technical-changes-of-the-blog-inspired-by-az-202-certification-study by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 31 Jul 2023 04:28:22 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>


    <!--- basic page needs
    ================================================== -->
    <meta charset="utf-8">
    <meta name="description" content="This blog is concentrated to Microsoft and cloud technology, coding and architecture. Solutions, tips and knowledge from a developer to developer.">

    <meta name="author" content="Kalle Marjokorpi">

    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="../css/vendor.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/cookieconsent.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="../css/tags.css">

    <!-- script
    ================================================== -->
    <script src="../js/modernizr.js"></script>
    <script defer src="../js/fontawesome/all.min.js"></script>

    <!-- favicons
    ================================================== -->
    <script type="text/plain" data-cookiecategory="analytics" async src="https://www.googletagmanager.com/gtag/js?id=G-DPTCQBZTWE"></script>
    <script type="text/plain" data-cookiecategory="analytics">
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DPTCQBZTWE');
    </script>
    
    <script defer type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "gr1x6zhls1");
    </script>

    
    <title>Technical changes of the Blog inspired by AZ-202 certification study - Blog by Kalle Marjokorpi</title>
    <meta name="description" content="I studied to AZ-202 Azure Developer transition certification during March. I was earlier completed the 70-532 certification so I was able to">
    <meta name="author" content="Kalle Marjokorpi">



    <script defer src="../js/cookieconsent.js"></script>
    <script defer src="../js/cookieconsent-config.js"></script>
    <script src="https://cdn.counter.dev/script.js" data-id="a019f4e1-6ec3-4293-8b98-7440925a9066" data-utcoffset="2"></script>
    <script defer src="../js/cusdis.es.js"></script>

</head>
<body id="top">

    <!-- preloader
    ================================================== -->
    <div id="preloader">
        <div id="loader"></div>
    </div>

    <!-- header
    ================================================== -->

    <!-- header
   ================================================== -->


 <!-- header
    ================================================== -->
<header class="s-header s-header--opaque">

        <div class="s-header__logo">
            Kalle Marjokorpi
        </div>

        <div class="row s-header__navigation">

            

    <nav class="s-header__nav-wrap">
        <h3 class="s-header__nav-heading h6">Navigate to</h3>

        <ul class="s-header__nav">


            <li><a id="top-navigation-link-root" href="../index.html" title="Home">Home</a></li>

                <li><a id="top-navigation-link-about"  href="../about.html" title="About me">About me</a></li>


        </ul> <!-- end s-header__nav -->

        <a href="#0" title="Close Menu" class="s-header__overlay-close close-mobile-menu">Close</a>

    </nav> <!-- end s-header__nav-wrap -->


            

        </div> <!-- end s-header__navigation -->

        <a class="s-header__toggle-menu" href="#0" title="Menu"><span>Menu</span></a>


    </header> <!-- end s-header -->




    



    <!-- content
        ================================================== -->
    <section class="s-content">

        <div class="row">
            <div class="column large-12">

                <article class="s-content__entry format-standard">


                    <div class="s-content__entry-header">
                    <h1 class="s-content__title s-content__title--post">Service Fabric testing inspired by AZ-202 certification study</h1>
                    </div> <!-- end s-content__entry-header -->

                    <div class="s-content__primary">

                        <div class="s-content__entry-content">

                            <p>I studied to AZ-202 Azure Developer transition certification during March. I was earlier completed the 70-532 certification so I was able to go AZ-202 (transition) certification exam. AZ-202 covered the following topics:</p>
<p><strong>Develop for cloud storage </strong></p>
<ul>
<li>Develop solutions that use file storage</li>
<li>Develop solutions that use a relational database</li>
</ul>
<p><strong>Create Platform as a Service (PaaS) Solutions </strong></p>
<ul>
<li>Create an app service Logic App</li>
<li>Create app or service that runs on Service Fabric</li>
<li>Schedule bulk operations</li>
<li>Design and develop applications that run in containers</li>
</ul>
<p><strong>Secure cloud solutions </strong></p>
<ul>
<li>Implement access control</li>
</ul>
<p><strong>Develop for an Azure cloud model </strong></p>
<ul>
<li>Develop for autoscaling</li>
</ul>
<p><strong>Implement cloud integration solutions </strong></p>
<ul>
<li>Configure a message-based integration architecture</li>
<li>Develop an application message model</li>
</ul>
<p>Topics were quite familiar to me except Service Fabric. It was a new technology what I haven't used in any work or personal projects. The best study method for me is to do hands on practices while browsing materials and documents. So I decided to refactor my Blog application while learning Service Fabric. This blog is now running top of the Service Fabric.</p>
<p>This blog post is not a deep dive to the Service Fabric. I describe this Blog application changes mostly from the architectural point of view. I had some difficulties with the SSL configuration show I described that more detailed.&nbsp;</p>
<h2>Basic information about Azure Service Fabric</h2>
<p>A few words about Service Fabric. What is a Azure Service Fabric? Microsoft has described <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-technical-overview">Azure Service Fabric</a>: "Azure Service Fabric is a distributed systems platform that makes it easy to package, deploy, and manage scalable and reliable micro services. You can host Service Fabric clusters anywhere: Azure, in an on-premises data center, or on any cloud provider. Basically Service Fabric is a micro service backbone which enables you to build scalable and reliable applications. Microsoft has built multiple Azure services top of Service Fabric like Azure SQL Database, Cosmos DB, PowerBI etc.</p>
<p>Service Fabric has Stateless and Statefull services. Stateless service is a logical choice when service's persistent state is stored in an external service (ex. Database). Statefull Service allows Service Fabric to maintain the state via Reliable Collections or Reliable Actors.</p>
<h2>Pluralsight cources</h2>
<p>Pluralsight have good cources about Service Fabric which I recommend to go through while learning:</p>
<p><a href="https://www.pluralsight.com/courses/azure-service-fabric-programming-models">Understanding the Programming Models of Azure Service Fabric by Ivan Gavryliuk</a><br /><a href="https://www.pluralsight.com/courses/azure-service-fabric-production">Using Azure Service Fabric in Production by Ivan Gavryliuk</a><br /><a href="https://www.pluralsight.com/courses/building-application-azure-service-fabric-mesh">Building an Application with Azure Service Fabric Mesh by Ivan Gavryliuk</a></p>
<h2>Creating a Service Fabric Cluster</h2>
<p>You can create Service Fabric Cluster via Azure CLI by using az sf cluster create command. More details about the command you can find from <a href="https://docs.microsoft.com/en-us/cli/azure/sf/cluster?view=azure-cli-latest#az-sf-cluster-create">here</a>. And of course you can create cluster in <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-portal">Azure Portal</a>. Notice that provisioning the Service Fabric Cluster might take some time.&nbsp;<a href="https://blog.nilayparikh.com/azure/computing/a-step-by-step-to-guide-to-setup-service-fabric-cluster-and-node-types/">Nilay Parikh</a> has written a good step-by-step guide to setup Service Fabric Cluster.</p>
<h2>Service Fabric Blog Application architecture</h2>
<p>I currently have three micro service components in my Service Fabric Cluster:</p>
<p>1) Blog Web Application (Stateless Service)<br />2) Backend Content Service (Stateless Service)<br />3) Analytics Service (Statefull Service)<br /><br />Communication between services is handled via Service Fabric service remoting. Other possibility is of course to use HTTP endpoints. I wanted to use service remoting because it's a Service Fabric's unique way to do communication between services.</p>
<p><img src="https://cdn.buttercms.com/8mqYoY2ES7yQXOqVveDc" alt="undefined" /></p>
<h3>Blog Web Application (Stateless Service)</h3>
<p>Blog Web is the application which shows the Blog content for end users (front-end). Application is stateless because it doesn't have any state. This application is the same .NET Core MVC application which I created a year ago.</p>
<h3>Content Service (Stateless Service)</h3>
<p>Content Service is a stateless component which delivers all blog contents for Blog Web Application. Basically during the refactoring I moved all ButterCMS API call logic from earlier version of my Blog Application to this new Service Fabric Stateless Service project. Project has no nothing specially. It executes calls to the ButterCMS API which is outside of the Service Fabric Cluster. Mae by later I change this project to Statefull and I'll use Reliable Collections as a caching purposes.</p>
<h3>Analytics Service (Statefull Service)</h3>
<p>I wanted also learn more about Reliable Collections so I created one Statefull Service. Analytics Statefull service stores all pageview data to the Reliable Collection. Data in the Reliable Collections are replicated across the Service Fabric Cluster.</p>
<p>Basically I have ASP.NET Core Middleware component in the Blog application which gets page and user agent information and sends it to the Analytics service via service remoting.</p>
<h2>Configure SSL certificate for your site</h2>
<p>I found several instructions from internet, how to do this but didn't find a complete guide which works. This section shows how I managed to get this working.</p>
<h3>Upload your site SSL certificate to the KeyVault</h3>
<p>Before uploading your site certificate to KeyVault convert your CRT-file certificate to PFX using ex. Openssl:</p>
<pre class="language-undefined"><code>openssl pkcs12 -export -out "d:\certificates\mysite.pfx" -inkey "d:\certificates\mysite.key" -in "d:\certificates\mysite.crt"</code></pre>
<p><img src="https://cdn.buttercms.com/5XCI0XApRE2H87FwjfpD" alt="undefined" /></p>
<p><img src="https://cdn.buttercms.com/6Onx7NHTkS07mUUER2gA" alt="undefined" /></p>
<p>After upload open certificate from Keyvault and copy the secret identifier value to the clipboard</p>
<p><img src="https://cdn.buttercms.com/wXyOOfBHTMiN3mJtmmzv" alt="undefined" /></p>
<h3>Add certificate to the Service Fabric nodes</h3>
<p>Use Add-AzureRmServiceFabricApplicationCertificate to install a certificate to all nodes in the cluster. You can specify a certificate you already have or have the system generate a new one for you, and upload it to a new or existing Azure key vault. Source:&nbsp;<a href="https://docs.microsoft.com/en-us/powershell/module/azurerm.servicefabric/add-azurermservicefabricapplicationcertificate?view=azurermps-6.13.0">Add-AzureRmServiceFabricApplicationCertificate</a></p>
<pre class="language-undefined"><code>$secret = "https://[MyKeyvault].vault.azure.net/secrets/[MyCertificate]/[MyCertificateId]"
$groupname="[MyResourceGroupName]"
$clustername = "[MyServiceFabricClusterName]"

Add-AzureRmServiceFabricApplicationCertificate -ResourceGroupName $groupname -Name $clustername -SecretIdentifier $secret -Verbose</code></pre>
<h3>Open 443 Port in Load Balancer</h3>
<p>I found this script from <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-tutorial-dotnet-app-enable-https-endpoint#open-port-443-in-the-azure-load-balancer">here</a>.</p>
<pre class="language-undefined"><code>$probename = "AppPortProbe"
$rulename="AppPortLBRule"
$RGname="[MyResourceGroupName]"
$port=443

# Get the load balancer resource
$resource = Get-AzResource | Where {$_.ResourceGroupName &ndash;eq $RGname -and $_.ResourceType -eq "Microsoft.Network/loadBalancers"}
$slb = Get-AzLoadBalancer -Name $resource.Name -ResourceGroupName $RGname

# Add a new probe configuration to the load balancer
$slb | Add-AzLoadBalancerProbeConfig -Name $probename -Protocol Tcp -Port $port -IntervalInSeconds 15 -ProbeCount 2

# Add rule configuration to the load balancer
$probe = Get-AzLoadBalancerProbeConfig -Name $probename -LoadBalancer $slb
$slb | Add-AzLoadBalancerRuleConfig -Name $rulename -BackendAddressPool $slb.BackendAddressPools[0] -FrontendIpConfiguration $slb.FrontendIpConfigurations[0] -Probe $probe -Protocol Tcp -FrontendPort $port -BackendPort $port

# Set the goal state for the load balancer
$slb | Set-AzLoadBalancer</code></pre>
<h3>Service Fabric ApplicationManifest changes</h3>
<p>This rule allows Network service to get access to the certificate.</p>
<pre class="language-undefined"><code> &lt;Principals&gt;
    &lt;Users&gt;
      &lt;User Name="NETWORK SERVICE" AccountType="NetworkService" /&gt;
    &lt;/Users&gt;
  &lt;/Principals&gt;
  &lt;Policies&gt;
    &lt;SecurityAccessPolicies&gt;
      &lt;SecurityAccessPolicy ResourceRef="HttpsCert" PrincipalRef="NETWORK SERVICE" ResourceType="Certificate" /&gt;
    &lt;/SecurityAccessPolicies&gt;
  &lt;/Policies&gt;
  &lt;Certificates&gt;
    &lt;SecretsCertificate X509FindValue="[MyCertificateThumbprint]" Name="HttpsCert" /&gt;
  &lt;/Certificates&gt;</code></pre>
<h3>ServiceManifest changes in the web project</h3>
<p>Add new 443 HTTPS endpoint to the service manifest.</p>
<pre class="language-undefined"><code>  &lt;Resources&gt;
    &lt;Endpoints&gt;
      &lt;Endpoint Protocol="http" Name="ServiceEndpoint" Type="Input" Port="80" /&gt;      
      &lt;Endpoint Protocol="https" Name="ServiceHttpsEndpoint" Type="Input" Port="443" /&gt;
    &lt;/Endpoints&gt;
  &lt;/Resources&gt;</code></pre>
<h3>Endpoint changes (web project)</h3>
<p>Service Listener changed to use new HTTPS endpoint. Certificate will be fetched from the VM nodes certificate store.</p>
<pre class="language-csharp"><code> /// &lt;summary&gt;
        /// Optional override to create listeners (like tcp, http) for this service instance.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The collection of listeners.&lt;/returns&gt;
        protected override IEnumerable&lt;ServiceInstanceListener&gt; CreateServiceInstanceListeners()
        {
            return new ServiceInstanceListener[]
              {
                      new ServiceInstanceListener(serviceContext =&gt;
                          new KestrelCommunicationListener(serviceContext, "ServiceHttpsEndpoint", (url, listener) =&gt;
                          {
                              ServiceEventSource.Current.ServiceMessage(serviceContext, $"Starting Kestrel on {url}");

                              return new WebHostBuilder()
                                          .UseKestrel(opt =&gt;
                                          {
                                              int port = serviceContext.CodePackageActivationContext.GetEndpoint("ServiceHttpsEndpoint").Port;
                                              opt.Listen(IPAddress.IPv6Any, port, listenOptions =&gt;
                                              {
                                                  listenOptions.UseHttps(GetCertificateFromStore());
                                              });
                                          })
                                          .ConfigureServices(
                                              services =&gt; services
                                                  .AddSingleton&lt;StatelessServiceContext&gt;(serviceContext))
                                          .UseContentRoot(Directory.GetCurrentDirectory())
                                          .UseStartup&lt;Startup&gt;()
                                          .UseServiceFabricIntegration(listener, ServiceFabricIntegrationOptions.None)
                                          .UseUrls(url)
                                          .Build();
                          }))
              };
        }

 public static X509Certificate2 GetCertificateFromStore()
        {
            var store = new X509Store(StoreName.My, StoreLocation.LocalMachine);
            try
            {
                store.Open(OpenFlags.ReadOnly);
                var certCollection = store.Certificates;
                var currentCerts = certCollection.Find(X509FindType.FindByThumbprint, "[MyCertificateThumbprintFromConfiguration]", false);
                return currentCerts.Count == 0 ? null : currentCerts[0];
            }
            finally
            {
                store.Close();
            }
        }</code></pre>
<p>That's it now it's working.</p>

                        </div> <!-- end s-entry__entry-content -->

                        <div class="s-content__entry-meta">

                            <div class="entry-author meta-blk">
                                <div class="author-avatar">
                                <img class="avatar" src="../images/avatars/kalle.jpg" alt="">
                                </div>
                                <div class="byline">
                                    <span class="bytext">Posted By</span>
                                    Kalle Marjokorpi
                                </div>
                            </div>

                            <div class="meta-bottom">

                                <div class="entry-cat-links meta-blk">

                                    <span>On</span>
19.05.2019                                </div>

                                <div class="entry-tags meta-blk">
                                    <span class="tagtext">Tags</span>
                                            <a id="post-category-azure" href="category/azure.html">Azure</a>
                                            <a id="post-category-azure-service-fabric" href="category/azure-service-fabric.html">Azure Service Fabric</a>
                                </div>

                            </div>

                        </div> <!-- s-content__entry-meta -->

                        <div class="s-content__pagenav">
                            <div class="prev-nav">
                                    <a id="post-previous-how-to-import-exercise-data-to-strava" href="how-to-import-exercise-data-to-strava.html" rel="prev">
                                        <span>Previous</span>
                                        How to import exercise data to Strava
                                    </a>
                            </div>
                            <div class="next-nav">

                 
                                <a id="post-next-how-to-configure-azure-ad-b2c-and-b2b-work-together" href="how-to-configure-azure-ad-b2c-and-b2b-work-together.html" rel="next">
                                    <span>Next</span>
                                    Identity management - How to configure Azure AD B2C and B2B work together?
                                </a>

                            
                            </div>
                        </div> <!-- end s-content__pagenav -->

                    </div> <!-- end s-content__primary -->
                </article> <!-- end entry -->

            </div> <!-- end column -->
        </div> <!-- end row -->
        <!-- comments
        ================================================== -->
        <div class="comments-wrap">

            <div id="comments" class="row">
                <div class="column large-12">

                    <h3>Comments</h3>

                    <script src="https://utteranc.es/client.js"
                            repo="kalleantero/kalleantero.github.io"
                            issue-term="url"
                            theme="github-light"
                            crossorigin="anonymous"
                            async>
                    </script>



                </div> <!-- end col-full -->
            </div> <!-- end comments -->



        </div> <!-- end comments-wrap -->


    </section> <!-- end s-content -->




    


<!-- footer
================================================== -->
<footer class="s-footer">




    <div class="s-footer__bottom">
        <div class="row">
            <div class="column">
                <div class="ss-copyright">
                    <span>Copyright Kalle Marjokorpi 2023</span>
                    <span>Design by <a href="http://www.styleshout.com/">styleshout</a></span>
                    <span>Content management by <a href="http://www.buttercms.com/">Headless ButterCMS</a></span>

                </div> <!-- end ss-copyright -->
            </div>
        </div>

        <div class="ss-go-top">
            <a class="smoothscroll" title="Back to Top" href="#top">
                <svg viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" width="15" height="15"><path d="M7.5 1.5l.354-.354L7.5.793l-.354.353.354.354zm-.354.354l4 4 .708-.708-4-4-.708.708zm0-.708l-4 4 .708.708 4-4-.708-.708zM7 1.5V14h1V1.5H7z" fill="currentColor"></path></svg>
            </a>
        </div> <!-- end ss-go-top -->
    </div> <!-- end s-footer__bottom -->

</footer> <!-- end s-footer -->
   
    <!-- Java Script
     ================================================== -->

    
    
    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "cac9fd24c1c04b6d9984ea31685b0414"}'></script><!-- End Cloudflare Web Analytics -->
    
    <script src="../js/jquery-3.5.0.min.js"></script>
    <script src="../js/plugins.js"></script>
    <script src="../js/main.js"></script>

    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="kmarjok" data-description="Support me on Buy me a coffee!" data-message="" data-color="#40DCA5" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

</body>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/technical-changes-of-the-blog-inspired-by-az-202-certification-study by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 31 Jul 2023 04:28:22 GMT -->
</html>
