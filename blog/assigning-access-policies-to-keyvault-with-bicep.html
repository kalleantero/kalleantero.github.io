<!DOCTYPE html>
<html>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/assigning-access-policies-to-keyvault-with-bicep by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Dec 2022 07:56:29 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>

    <!--- basic page needs
    ================================================== -->
    <meta charset="utf-8">

    
    <title>Assigning Access Policies to KeyVault with Bicep - Blog by Kalle Marjokorpi</title>
    <meta name="description" content="This blog post covers how to assign Access Policies to KeyVault with Bicep.">
    <meta name="author" content="Kalle Marjokorpi">


    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="../css/basefead.css?dt=638056507702873372">
    <link rel="stylesheet" href="../css/vendorfead.css?dt=638056507702873372">
    <link rel="stylesheet" href="../css/mainfead.css?dt=638056507702873372">
    <script src="../js/modernizr.js"></script>

    <script type="text/javascript">
        !function (T, l, y) { var S = T.location, k = "script", D = "instrumentationKey", C = "ingestionendpoint", I = "disableExceptionTracking", E = "ai.device.", b = "toLowerCase", w = "crossOrigin", N = "POST", e = "appInsightsSDK", t = y.name || "appInsights"; (y.name || T[e]) && (T[e] = t); var n = T[t] || function (d) { var g = !1, f = !1, m = { initialize: !0, queue: [], sv: "5", version: 2, config: d }; function v(e, t) { var n = {}, a = "Browser"; return n[E + "id"] = a[b](), n[E + "type"] = a, n["ai.operation.name"] = S && S.pathname || "_unknown_", n["ai.internal.sdkVersion"] = "javascript:snippet_" + (m.sv || m.version), { time: function () { var e = new Date; function t(e) { var t = "" + e; return 1 === t.length && (t = "0" + t), t } return e.getUTCFullYear() + "-" + t(1 + e.getUTCMonth()) + "-" + t(e.getUTCDate()) + "T" + t(e.getUTCHours()) + ":" + t(e.getUTCMinutes()) + ":" + t(e.getUTCSeconds()) + "." + ((e.getUTCMilliseconds() / 1e3).toFixed(3) + "").slice(2, 5) + "Z" }(), iKey: e, name: "Microsoft.ApplicationInsights." + e.replace(/-/g, "") + "." + t, sampleRate: 100, tags: n, data: { baseData: { ver: 2 } } } } var h = d.url || y.src; if (h) { function a(e) { var t, n, a, i, r, o, s, c, u, p, l; g = !0, m.queue = [], f || (f = !0, t = h, s = function () { var e = {}, t = d.connectionString; if (t) for (var n = t.split(";"), a = 0; a < n.length; a++) { var i = n[a].split("="); 2 === i.length && (e[i[0][b]()] = i[1]) } if (!e[C]) { var r = e.endpointsuffix, o = r ? e.location : null; e[C] = "https://" + (o ? o + "." : "") + "dc." + (r || "services.visualstudio.com") } return e }(), c = s[D] || d[D] || "", u = s[C], p = u ? u + "/v2/track" : d.endpointUrl, (l = []).push((n = "SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)", a = t, i = p, (o = (r = v(c, "Exception")).data).baseType = "ExceptionData", o.baseData.exceptions = [{ typeName: "SDKLoadFailed", message: n.replace(/\./g, "-"), hasFullStack: !1, stack: n + "\nSnippet failed to load [" + a + "] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: " + (S && S.pathname || "_unknown_") + "\nEndpoint: " + i, parsedStack: [] }], r)), l.push(function (e, t, n, a) { var i = v(c, "Message"), r = i.data; r.baseType = "MessageData"; var o = r.baseData; return o.message = 'AI (Internal): 99 message:"' + ("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) (" + n + ")").replace(/\"/g, "") + '"', o.properties = { endpoint: a }, i }(0, 0, t, p)), function (e, t) { if (JSON) { var n = T.fetch; if (n && !y.useXhr) n(t, { method: N, body: JSON.stringify(e), mode: "cors" }); else if (XMLHttpRequest) { var a = new XMLHttpRequest; a.open(N, t), a.setRequestHeader("Content-type", "application/json"), a.send(JSON.stringify(e)) } } }(l, p)) } function i(e, t) { f || setTimeout(function () { !t && m.core || a() }, 500) } var e = function () { var n = l.createElement(k); n.src = h; var e = y[w]; return !e && "" !== e || "undefined" == n[w] || (n[w] = e), n.onload = i, n.onerror = a, n.onreadystatechange = function (e, t) { "loaded" !== n.readyState && "complete" !== n.readyState || i(0, t) }, n }(); y.ld < 0 ? l.getElementsByTagName("head")[0].appendChild(e) : setTimeout(function () { l.getElementsByTagName(k)[0].parentNode.appendChild(e) }, y.ld || 0) } try { m.cookie = l.cookie } catch (p) { } function t(e) { for (; e.length;)!function (t) { m[t] = function () { var e = arguments; g || m.queue.push(function () { m[t].apply(m, e) }) } }(e.pop()) } var n = "track", r = "TrackPage", o = "TrackEvent"; t([n + "Event", n + "PageView", n + "Exception", n + "Trace", n + "DependencyData", n + "Metric", n + "PageViewPerformance", "start" + r, "stop" + r, "start" + o, "stop" + o, "addTelemetryInitializer", "setAuthenticatedUserContext", "clearAuthenticatedUserContext", "flush"]), m.SeverityLevel = { Verbose: 0, Information: 1, Warning: 2, Error: 3, Critical: 4 }; var s = (d.extensionConfig || {}).ApplicationInsightsAnalytics || {}; if (!0 !== d[I] && !0 !== s[I]) { var c = "onerror"; t(["_" + c]); var u = T[c]; T[c] = function (e, t, n, a, i) { var r = u && u(e, t, n, a, i); return !0 !== r && m["_" + c]({ message: e, url: t, lineNumber: n, columnNumber: a, error: i }), r }, d.autoExceptionInstrumented = !0 } return m }(y.cfg); function a() { y.onInit && y.onInit(n) } (T[t] = n).queue && 0 === n.queue.length ? (n.queue.push(a), n.trackPageView({})) : a() }(window, document, {
            src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", // The SDK URL Source
            // name: "appInsights", // Global SDK Instance name defaults to "appInsights" when not supplied
            // ld: 0, // Defines the load delay (in ms) before attempting to load the sdk. -1 = block page load and add to head. (default) = 0ms load after timeout,
            // useXhr: 1, // Use XHR instead of fetch to report failures (if available),
            crossOrigin: "anonymous", // When supplied this will add the provided value as the cross origin attribute on the script tag
            // onInit: null, // Once the application insights instance has loaded and initialized this callback function will be called with 1 argument -- the sdk instance (DO NOT ADD anything to the sdk.queue -- As they won't get called)
            cfg: { // Application Insights Configuration
                instrumentationKey: "5c788919-72be-4412-ae6b-74d2981b98bf"
            }
        });
    </script>

</head>
<body id="top">
   
    <!-- header
    ================================================== -->

    <!-- header
   ================================================== -->

<header class="s-header">

    <div class="header-logo">
        <a class="site-logo" href="../index.html"><img src="../images/logo2.png" alt="Homepage"></a>
    </div>

    

    <nav class="header-nav-wrap">

        <ul class="header-nav">


            <li class=""><a id="top-navigation-link-root" href="../index.html" title="">Home</a></li>

                <li id="top-navigation-link-about" class="smoothscroll"><a href="../about.html" title="">About me</a></li>

        </ul>
    </nav> <!-- end main-nav-wrap -->




    <a class="header-menu-toggle" href="#0"><span>Menu</span></a>

</header> <!-- end s-header -->



    

<!-- content
   ================================================== -->


    <article class="blog-single">

        <!-- page header/blog hero
    ================================================== -->

        
        <div class="page-header page-header--single page-hero" style=background-image:url(https://cdn.buttercms.com/wRY6suhRPyociJPuoo1F)>

            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                                <a id="post-category-azure" href="category/azure.html">Azure</a>
                                <a id="post-category-bicep" href="category/bicep.html">bicep</a>
                                <a id="post-category-infrastructure-as-a-code" href="category/infrastructure-as-a-code.html">infrastructure as a code</a>
                                <a id="post-category-keyvault" href="category/keyvault.html">KeyVault</a>
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        <a href="#0" title="">
                            Lessons learned: Assigning Access Policies to KeyVault with Bicep
                        </a>
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">
03.11.2021 07:39                        </li>
                        <li class="author">
                            By
                            <span>Kalle Marjokorpi</span>
                        </li>
                    </ul>

                </article>
                
            </div>

        </div> <!-- end page-header -->

        <div class="row blog-content">
            <div class="col-full blog-content__main">

                <p><h2>Example architecture</h2>
<p>Chart below describes a quite typical architecture where Microservice resources and KeyVault have own resource groups. KeyVault is typically located in own resource group because it's often considered as an environment specific resource which is used by multiple resources/services. This blog post covers what I learned when deploying this kind of infrastructure as a code with Bicep when you have to interactive with multiple resource groups.&nbsp;</p>
<h2><img src="https://cdn.buttercms.com/bYohPYsSPOpp9peuHbvU" alt="undefined" /></h2>
<h2>Bicep implementation</h2>
<h3>App Service module</h3>
<p>This module creates App Service, enables Managed Identity and sets same preferred settings. Module returns principal Id of App Service when resource is created.</p>
<pre class="language-undefined"><code>@description('Name of the App Service Plan')
param appServicePlanName string

@description('The SKU of App Service Plan.')
param appServicePlanSku string = 'S1'

@allowed([
  'Win'
  'Linux'
])
@description('Select the OS type to deploy.')
param appServicePlanPlatform string

@description('Name of the App Service')
param appServiceName string
param tags object
param appSettings array

resource appServicePlan 'Microsoft.Web/serverfarms@2021-02-01' = {
  name: appServicePlanName
  location: resourceGroup().location
  sku: {
    name: appServicePlanSku
  }
  kind: ((appServicePlanPlatform == 'Linux') ? 'linux' : 'windows')
  tags:tags
}

resource appService 'Microsoft.Web/sites@2021-02-01' = {
  name: appServiceName
  location: resourceGroup().location
  identity: {
     type: 'SystemAssigned'
  }
  properties:{
    serverFarmId: appServicePlan.id
    siteConfig:{
      alwaysOn: true
      ftpsState: 'Disabled'
      netFrameworkVersion: 'v6.0'
      ipSecurityRestrictions:[
        {
            ipAddress: 'xxx.xxx.xxx.xxx/32'
            action: 'Allow'
            tag: 'Default'
            priority: 100
            name: 'Allow Access from my IP'
        }
        {
          ipAddress: 'Any'
          action: 'Deny'
          priority: 2147483647
          name: 'Deny all'
          description: 'Deny all access'
        }
      ]
      scmIpSecurityRestrictionsUseMain: true
      appSettings: appSettings
    }
    httpsOnly: true    
  }
  tags:tags
}

output principalId string = appService.identity.principalId</code></pre>
<h3>Main Bicep file</h3>
<p>Main file orchestrates the creation of infrastructure.</p>
<p><strong>Parameter declaration</strong></p>
<pre class="language-undefined"><code>@description('Name of the App Service Plan')
param appServicePlanName string

@description('Name of the Application Insights')
param applicationInsightsName string

@description('The SKU of App Service Plan.')
param appServicePlanSku string = 'S1'

@allowed([
  'Win'
  'Linux'
])
@description('Select the OS type to deploy.')
param appServicePlanPlatform string

@description('Name of the App Service')
param appServiceName string</code></pre>
<p><strong>Utilize App Service Module to create App Service</strong></p>
<pre class="language-undefined"><code>module appService './appservice.bicep' = {
  name: 'appService'
  params: {
      appServiceName: appServiceName
      appServicePlanName: appServicePlanName
      appServicePlanPlatform: appServicePlanPlatform
      appServicePlanSku: appServicePlanSku
      tags:defaultTags
      appSettings: appSettings
  }
}</code></pre>
<p>Now Managed Identity enabled App Service is created. Next access policies to KeyVault should be created to enable App Service communication with KeyVault.</p>
<h2>Failed tryouts</h2>
<p><strong>1. Referencing existing KeyVault in Main Bicep file&nbsp;</strong></p>
<p>I first created reference to existing KeyVault like this. With scope I explicitly specified the resource group of KeyVault.&nbsp;</p>
<pre class="language-undefined"><code>resource keyVault 'Microsoft.KeyVault/vaults@2019-09-01' existing = {
  name: keyVaultResourceName
  scope: resourceGroup(subscription().subscriptionId, 'rg-keyvault') 
}</code></pre>
<p>KeyVault reference seems to be working fine. Access policies of KeyVault should be added next. I found several examples to assign access policies like this:</p>
<pre class="language-undefined"><code>resource keyVaultPolicies 'Microsoft.KeyVault/vaults/accessPolicies@2021-06-01-preview' = {
  dependsOn:[
    keyVault
  ]
  name: '${keyVault.name}/add'
  properties: {    
    accessPolicies: [
      {
        objectId: appService.outputs.principalId
        permissions: {
          secrets: [ 
            'get'
          ]
        }
        tenantId: subscription().tenantId
      }
    ]
  }
}  </code></pre>
<p>Everything looks good so let's deploy infrastructure with the following Azure CLI command</p>
<blockquote>
<p>NOTE: 'rg-bicep' is a Resource Group where App Service will be created. KeyVault is not located in that Resource Group!</p>
</blockquote>
<pre class="language-undefined"><code>az deployment group create --resource-group rg-bicep --template-file main.bicep --parameters parameters/dev.parameters.json</code></pre>
<p>This didn't work because the following error occurred:</p>
<pre class="language-undefined"><code>{
    "status": "Failed",
    "error": {
        "code": "ParentResourceNotFound",
        "message": "Can not perform requested operation on nested resource. Parent resource 'MYKEYVAULTRESOURCE' not found."
    }
}</code></pre>
<p>Seems that KeyVault is not found. KeyVault is tried to find from the same Resource Group where App Service is located.&nbsp;</p>
<blockquote>
<p>NOTE: This is working if KeyVault is located to the same Resource Group</p>
</blockquote>
<p><strong>2. Changed scope of Access Policy resource declaration in Main Bicep file&nbsp;</strong></p>
<p>Next I tried to add scope to the Access Policy resource declaration similar way like in KeyVault resource declaration. Visual Studio Code showed immediately warning that this is not allowed: "The root resource scope must match that of the Bicep file. To deploy a resource to a different root scope, use a module".</p>
<p><img src="https://cdn.buttercms.com/ZQ3iY8M1Rk2HGGLUT62m" alt="undefined" /></p>
<p>That warning was a really good because it revealed that this is not the right way to handle this kind of scenario.</p>
<h2>Refactored solution</h2>
<h3>KeyVault policy Module</h3>
<p>Handling of KeyVault Access Policy is now separated to the own Bicep Module (keyvaultpolicy.bicep)</p>
<pre class="language-undefined"><code>@description('Name of the KeyVault resource ex. kv-myservice.')
param keyVaultResourceName string
@description('Principal Id of the Azure resource (Managed Identity).')
param principalId string
@description('Assigned permissions for Principal Id (Managed Identity)')
param keyVaultPermissions object
@allowed([
  'add'
  'remove'
  'replace'
])
@description('Policy action.')
param policyAction string

resource keyVault 'Microsoft.KeyVault/vaults@2019-09-01' existing = {
  name: keyVaultResourceName
  resource keyVaultPolicies 'accessPolicies' = {
    dependsOn:[
      keyVault
    ]  
    name: policyAction
    properties: {    
      accessPolicies: [
        {
          objectId: principalId
          permissions: keyVaultPermissions
          tenantId: subscription().tenantId
        }
      ]
    }
  }  
}</code></pre>
<h3>Main Bicep file</h3>
<p>Scope configuration of the Module enables that we can configure different resource group for module than which is used in the main Bicep file context.</p>
<pre class="language-undefined"><code>var keyVaultPermissions = {
  secrets: [ 
    'get'
  ]
}

module keyVault './keyvaultpolicy.bicep' = {
  dependsOn: [
    appService
  ]
  scope: resourceGroup('rg-keyvault')
  name: 'keyVault'
  params: {
      keyVaultResourceName: keyVaultResourceName
      principalId: appService.outputs.principalId
      keyVaultPermissions: keyVaultPermissions
      policyAction: 'add'
  }
}</code></pre>
<p>This solved the problem!</p></p>

                <h2>Comments</h2>
                                    
                <div id="cusdis_thread"
                  data-host="https://cusdis.com"
                  data-app-id="86620953-7757-4f01-94f2-bfb88caff8a4"
                  data-page-id="assigning-access-policies-to-keyvault-with-bicep"
                  data-page-url="https://kalle-blog.azurewebsites.net/blog/assigning-access-policies-to-keyvault-with-bicep"
                  data-page-title="Lessons learned: Assigning Access Policies to KeyVault with Bicep">
                <script src="https://cusdis.com/js/cusdis.es.js"></script>

                <div class="blog-content__pagenav">
                    <div class="blog-content__nav">
                            <div class="blog-content__prev">
                                <a id="post-previous-deploy-azure-infrastructure-with-azure-bicep" href="deploy-azure-infrastructure-with-azure-bicep.html" rel="prev">
                                    <span>Previous Post</span>
                                    Deploy .NET 6 application and infrastructure to Azure with Bicep and YAML
                                </a>
                            </div>
                            <div class="blog-content__next">
                                <a id="post-next-deploy-net-6-web-app-to-linux-based-app-service" href="deploy-net-6-web-app-to-linux-based-app-service.html" rel="next">
                                    <span>Next Post</span>
                                    What you should know when deploying .NET 6 application to Linux based App Service?
                                </a>
                            </div>
                        </div>


                    <div class="blog-content__all">
                        <a href="../index.html" class="btn btn--primary">
                            View All Post
                        </a>
                    </div>
                </div>

            </div><!-- end blog-content__main -->
        </div> <!-- end blog-content -->

    </article>



    

<!-- footer
    ================================================== -->
<footer>
    <div class="row">
        <div class="col-full">

            <div class="footer-logo">
                <a class="footer-site-logo" href="#0"><img src="../images/name.png" alt="Homepage"></a>
            </div>

            <ul class="footer-social">
                <li>
                    <a href="https://www.twitter.com/kmarjok">
                        <i class="im im-twitter" aria-hidden="true"></i>
                        <span>Twitter</span>
                    </a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/kallemarjokorpi">
                        <i class="im im-linkedin" aria-hidden="true"></i>
                        <span>Linkedin</span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/kalleantero">
                        <i class="im im-github" aria-hidden="true"></i>
                        <span>Github</span>
                    </a>
                </li>
            </ul>

        </div>
    </div>

    <div class="row footer-bottom">

        <div class="col-twelve">
            <div class="copyright">
                <span>Copyright Kalle Marjokorpi 2022</span>
                <span>Design by <a href="http://www.styleshout.com/">styleshout</a></span>
                <span>Content management by <a href="http://www.buttercms.com/">Headless ButterCMS</a></span>

            </div>

        </div>

    </div> <!-- end footer-bottom -->

</footer> <!-- end footer -->
   
    <!-- Java Script
     ================================================== -->

    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/plugins.js"></script>
    <script src="../js/main.min.js"></script>
    
    
    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "cac9fd24c1c04b6d9984ea31685b0414"}'></script><!-- End Cloudflare Web Analytics -->       

</body>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/assigning-access-policies-to-keyvault-with-bicep by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Dec 2022 07:56:32 GMT -->
</html>
