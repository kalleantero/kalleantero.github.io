<!DOCTYPE html>
<html>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/apple-health-data-conversion-to-fhir-observation by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Dec 2022 08:16:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>

    <!--- basic page needs
    ================================================== -->
    <meta charset="utf-8">

    
    <title>Apple Health data conversion to FHIR observation - Blog by Kalle Marjokorpi</title>
    <meta name="description" content="This blog post shows how to create a new handlebar template for FHIR converter which creates FHIR observations from Apple Health data (CDA).">
    <meta name="author" content="Kalle Marjokorpi">


    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="../css/base125a.css?dt=638056519063090932">
    <link rel="stylesheet" href="../css/vendor125a.css?dt=638056519063090932">
    <link rel="stylesheet" href="../css/main125a.css?dt=638056519063090932">
    <script src="../js/modernizr.js"></script>

    <script type="text/javascript">
        !function (T, l, y) { var S = T.location, k = "script", D = "instrumentationKey", C = "ingestionendpoint", I = "disableExceptionTracking", E = "ai.device.", b = "toLowerCase", w = "crossOrigin", N = "POST", e = "appInsightsSDK", t = y.name || "appInsights"; (y.name || T[e]) && (T[e] = t); var n = T[t] || function (d) { var g = !1, f = !1, m = { initialize: !0, queue: [], sv: "5", version: 2, config: d }; function v(e, t) { var n = {}, a = "Browser"; return n[E + "id"] = a[b](), n[E + "type"] = a, n["ai.operation.name"] = S && S.pathname || "_unknown_", n["ai.internal.sdkVersion"] = "javascript:snippet_" + (m.sv || m.version), { time: function () { var e = new Date; function t(e) { var t = "" + e; return 1 === t.length && (t = "0" + t), t } return e.getUTCFullYear() + "-" + t(1 + e.getUTCMonth()) + "-" + t(e.getUTCDate()) + "T" + t(e.getUTCHours()) + ":" + t(e.getUTCMinutes()) + ":" + t(e.getUTCSeconds()) + "." + ((e.getUTCMilliseconds() / 1e3).toFixed(3) + "").slice(2, 5) + "Z" }(), iKey: e, name: "Microsoft.ApplicationInsights." + e.replace(/-/g, "") + "." + t, sampleRate: 100, tags: n, data: { baseData: { ver: 2 } } } } var h = d.url || y.src; if (h) { function a(e) { var t, n, a, i, r, o, s, c, u, p, l; g = !0, m.queue = [], f || (f = !0, t = h, s = function () { var e = {}, t = d.connectionString; if (t) for (var n = t.split(";"), a = 0; a < n.length; a++) { var i = n[a].split("="); 2 === i.length && (e[i[0][b]()] = i[1]) } if (!e[C]) { var r = e.endpointsuffix, o = r ? e.location : null; e[C] = "https://" + (o ? o + "." : "") + "dc." + (r || "services.visualstudio.com") } return e }(), c = s[D] || d[D] || "", u = s[C], p = u ? u + "/v2/track" : d.endpointUrl, (l = []).push((n = "SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)", a = t, i = p, (o = (r = v(c, "Exception")).data).baseType = "ExceptionData", o.baseData.exceptions = [{ typeName: "SDKLoadFailed", message: n.replace(/\./g, "-"), hasFullStack: !1, stack: n + "\nSnippet failed to load [" + a + "] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: " + (S && S.pathname || "_unknown_") + "\nEndpoint: " + i, parsedStack: [] }], r)), l.push(function (e, t, n, a) { var i = v(c, "Message"), r = i.data; r.baseType = "MessageData"; var o = r.baseData; return o.message = 'AI (Internal): 99 message:"' + ("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) (" + n + ")").replace(/\"/g, "") + '"', o.properties = { endpoint: a }, i }(0, 0, t, p)), function (e, t) { if (JSON) { var n = T.fetch; if (n && !y.useXhr) n(t, { method: N, body: JSON.stringify(e), mode: "cors" }); else if (XMLHttpRequest) { var a = new XMLHttpRequest; a.open(N, t), a.setRequestHeader("Content-type", "application/json"), a.send(JSON.stringify(e)) } } }(l, p)) } function i(e, t) { f || setTimeout(function () { !t && m.core || a() }, 500) } var e = function () { var n = l.createElement(k); n.src = h; var e = y[w]; return !e && "" !== e || "undefined" == n[w] || (n[w] = e), n.onload = i, n.onerror = a, n.onreadystatechange = function (e, t) { "loaded" !== n.readyState && "complete" !== n.readyState || i(0, t) }, n }(); y.ld < 0 ? l.getElementsByTagName("head")[0].appendChild(e) : setTimeout(function () { l.getElementsByTagName(k)[0].parentNode.appendChild(e) }, y.ld || 0) } try { m.cookie = l.cookie } catch (p) { } function t(e) { for (; e.length;)!function (t) { m[t] = function () { var e = arguments; g || m.queue.push(function () { m[t].apply(m, e) }) } }(e.pop()) } var n = "track", r = "TrackPage", o = "TrackEvent"; t([n + "Event", n + "PageView", n + "Exception", n + "Trace", n + "DependencyData", n + "Metric", n + "PageViewPerformance", "start" + r, "stop" + r, "start" + o, "stop" + o, "addTelemetryInitializer", "setAuthenticatedUserContext", "clearAuthenticatedUserContext", "flush"]), m.SeverityLevel = { Verbose: 0, Information: 1, Warning: 2, Error: 3, Critical: 4 }; var s = (d.extensionConfig || {}).ApplicationInsightsAnalytics || {}; if (!0 !== d[I] && !0 !== s[I]) { var c = "onerror"; t(["_" + c]); var u = T[c]; T[c] = function (e, t, n, a, i) { var r = u && u(e, t, n, a, i); return !0 !== r && m["_" + c]({ message: e, url: t, lineNumber: n, columnNumber: a, error: i }), r }, d.autoExceptionInstrumented = !0 } return m }(y.cfg); function a() { y.onInit && y.onInit(n) } (T[t] = n).queue && 0 === n.queue.length ? (n.queue.push(a), n.trackPageView({})) : a() }(window, document, {
            src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", // The SDK URL Source
            // name: "appInsights", // Global SDK Instance name defaults to "appInsights" when not supplied
            // ld: 0, // Defines the load delay (in ms) before attempting to load the sdk. -1 = block page load and add to head. (default) = 0ms load after timeout,
            // useXhr: 1, // Use XHR instead of fetch to report failures (if available),
            crossOrigin: "anonymous", // When supplied this will add the provided value as the cross origin attribute on the script tag
            // onInit: null, // Once the application insights instance has loaded and initialized this callback function will be called with 1 argument -- the sdk instance (DO NOT ADD anything to the sdk.queue -- As they won't get called)
            cfg: { // Application Insights Configuration
                instrumentationKey: "5c788919-72be-4412-ae6b-74d2981b98bf"
            }
        });
    </script>

</head>
<body id="top">
   
    <!-- header
    ================================================== -->

    <!-- header
   ================================================== -->

<header class="s-header">

    <div class="header-logo">
        <a class="site-logo" href="../index.html"><img src="../images/logo2.png" alt="Homepage"></a>
    </div>

    

    <nav class="header-nav-wrap">

        <ul class="header-nav">


            <li class=""><a id="top-navigation-link-root" href="../index.html" title="">Home</a></li>

                <li id="top-navigation-link-about" class="smoothscroll"><a href="../about.html" title="">About me</a></li>

        </ul>
    </nav> <!-- end main-nav-wrap -->




    <a class="header-menu-toggle" href="#0"><span>Menu</span></a>

</header> <!-- end s-header -->



    

<!-- content
   ================================================== -->


    <article class="blog-single">

        <!-- page header/blog hero
    ================================================== -->

        
        <div class="page-header page-header--single page-hero" style=background-image:url(https://cdn.buttercms.com/Z0ByikLT7qRHytz48osw)>

            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                                <a id="post-category-azure-api-for-fhir" href="category/azure-api-for-fhir.html">Azure API for FHIR</a>
                                <a id="post-category-fhir-converter" href="category/fhir-converter.html">FHIR Converter</a>
                                <a id="post-category-health-care" href="category/health-care.html">Health Care</a>
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        <a href="#0" title="">
                            Apple Health CDA data conversion to FHIR with Handlebar engine
                        </a>
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">
10.04.2021 13:37                        </li>
                        <li class="author">
                            By
                            <span>Kalle Marjokorpi</span>
                        </li>
                    </ul>

                </article>
                
            </div>

        </div> <!-- end page-header -->

        <div class="row blog-content">
            <div class="col-full blog-content__main">

                <p><p>Previous <a href="https://www.kallemarjokorpi.fi/blog/export-apple-health-data-to-azure-api-for-fhir" rel="follow">blog post</a> I showed how to export Apple Health data to the Azure API for FHIR as an attachment document. This is not very useful approach especially from the search perspective. This blog post shows how to create a new handlebar template for FHIR converter which creates FHIR observation resources based on Apple Health Data.</p>
<h2>Handlebar template for FHIR converter</h2>
<p>Let's first create a one template for handling Patient resource and one for Observations.</p>
<h3>Patient template</h3>
<p>Patient template retrieves Patient data from CDA document's patient role section and converts it to FHIR patient resource.</p>
<p><strong>CDA Patient input</strong></p>
<p><img src="https://cdn.buttercms.com/VvKXCh37THqlX14LK3s6" alt="undefined" /></p>
<p><strong>Handlebar Template</strong></p>
<p>Name this template as "Sections/Patient.hbs"</p>
<pre class="language-undefined"><code>{{#with msg.ClinicalDocument.recordTarget.patientRole}}
    {{#with (evaluate 'Utils/GeneratePatientId.hbs' obj=this) as |patientId|}}
        {{&gt;Resources/Patient.hbs patientRole=.. ID=patientId.Id}}
    {{/with}}
{{/with}}  
</code></pre>
<p><strong>FHIR Patient output</strong></p>
<p><img src="https://cdn.buttercms.com/byHkpDA5TKKDgBujMuda" alt="undefined" /></p>
<h3>Observation template</h3>
<p>Observation template loops through Observations which are located under Entry/Organizer/Component.</p>
<p><strong>CDA Observation input</strong></p>
<p><strong><img src="https://cdn.buttercms.com/1Fagf7a5TWde1eKPK02n" alt="undefined" /></strong></p>
<h4><strong>Handlebar Template</strong></h4>
<p>Name this template as "Sections/Observation.hbs"</p>
<pre class="language-undefined"><code>{{#each (toArray msg.ClinicalDocument.entry) as |drEntry|}}
    {{#each (toArray this.organizer.component) as |obsEntry|}}
        {{#if obsEntry.observation}}
            {{&gt;Resources/Observation.hbs observationCategory="vital-signs" observationEntry=obsEntry.observation ID=(generateUUID (toJsonString obsEntry.observation))}},                   
                {{#with (evaluate 'Utils/GeneratePatientId.hbs' obj=../../msg.ClinicalDocument.recordTarget.patientRole) as |patientId|}}
                    {{&gt;References/Observation/subject.hbs ID=(generateUUID (toJsonString obsEntry.observation)) REF=(concat 'Patient/' patientId.Id)}}
                {{/with}}
        {{/if}}
    {{/each}}
{{/each}}</code></pre>
<p><strong>FHIR Observation output</strong></p>
<p><img src="https://cdn.buttercms.com/F39LYXGsRa2KAnxYbjN4" alt="undefined" /></p>
<h3>Main template</h3>
<p>Main template constructs FHIR bundle resource which has multiple entries. In this case entries (Patient and Observation) are populated in sub templates.</p>
<pre class="language-undefined"><code>{
    "resourceType": "Bundle",
    "type": "batch",
    "entry": [  
        {{&gt;Sections/Patient.hbs}}
        {{&gt;Sections/Observation.hbs}}
      ]
}</code></pre>
<p>In FHIR Converter everything looks like this:</p>
<h4><img src="https://cdn.buttercms.com/xDpZTxIxSnG5u2fdCtSw" alt="undefined" /></h4>
<p>Templates mentioned in this blog post founds also from my <a href="https://github.com/kalleantero/apple-health-handlebar-template/" rel="follow">Github repository</a>.</p>
<h2>Testing</h2>
<p>You can send the bundle resource directly to the Bundle endpoint of the Azure API for FHIR but better option is to send Patient and Observation resource individually. I mean that Patient resource is sent to Patient endpoint and Observations to the Observation endpoint.</p>
<p><strong>Sending individual observation to the Observation endpoint</strong></p>
<p><img src="https://cdn.buttercms.com/X6WS159QQtm4U5NA0DQJ" alt="undefined" /></p>
<p>After that you can easily find ex. specific patient's all observations.</p>
<p><img src="https://cdn.buttercms.com/mGcAeul9RPmnfQVP7q6J" alt="undefined" /></p>
<p></p>
<p></p></p>

                <h2>Comments</h2>
                                    
                <div id="cusdis_thread"
                  data-host="https://cusdis.com"
                  data-app-id="86620953-7757-4f01-94f2-bfb88caff8a4"
                  data-page-id="apple-health-data-conversion-to-fhir-observation"
                  data-page-url="https://kalle-blog.azurewebsites.net/blog/apple-health-data-conversion-to-fhir-observation"
                  data-page-title="Apple Health CDA data conversion to FHIR with Handlebar engine">
                <script src="https://cusdis.com/js/cusdis.es.js"></script>

                <div class="blog-content__pagenav">
                    <div class="blog-content__nav">
                            <div class="blog-content__prev">
                                <a id="post-previous-strava-webhook-azure-api-for-fhir" href="strava-webhook-azure-api-for-fhir.html" rel="prev">
                                    <span>Previous Post</span>
                                    How to setup Strava to Azure API for FHIR integration?
                                </a>
                            </div>
                            <div class="blog-content__next">
                                <a id="post-next-azure-b2c-custom-mfa-implementation" href="azure-b2c-custom-mfa-implementation.html" rel="next">
                                    <span>Next Post</span>
                                    Azure B2C custom MFA implementation
                                </a>
                            </div>
                        </div>


                    <div class="blog-content__all">
                        <a href="../index.html" class="btn btn--primary">
                            View All Post
                        </a>
                    </div>
                </div>

            </div><!-- end blog-content__main -->
        </div> <!-- end blog-content -->

    </article>



    

<!-- footer
    ================================================== -->
<footer>
    <div class="row">
        <div class="col-full">

            <div class="footer-logo">
                <a class="footer-site-logo" href="#0"><img src="../images/name.png" alt="Homepage"></a>
            </div>

            <ul class="footer-social">
                <li>
                    <a href="https://www.twitter.com/kmarjok">
                        <i class="im im-twitter" aria-hidden="true"></i>
                        <span>Twitter</span>
                    </a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/kallemarjokorpi">
                        <i class="im im-linkedin" aria-hidden="true"></i>
                        <span>Linkedin</span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/kalleantero">
                        <i class="im im-github" aria-hidden="true"></i>
                        <span>Github</span>
                    </a>
                </li>
            </ul>

        </div>
    </div>

    <div class="row footer-bottom">

        <div class="col-twelve">
            <div class="copyright">
                <span>Copyright Kalle Marjokorpi 2022</span>
                <span>Design by <a href="http://www.styleshout.com/">styleshout</a></span>
                <span>Content management by <a href="http://www.buttercms.com/">Headless ButterCMS</a></span>

            </div>

        </div>

    </div> <!-- end footer-bottom -->

</footer> <!-- end footer -->
   
    <!-- Java Script
     ================================================== -->

    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/plugins.js"></script>
    <script src="../js/main.min.js"></script>
    
    
    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "cac9fd24c1c04b6d9984ea31685b0414"}'></script><!-- End Cloudflare Web Analytics -->       

</body>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/apple-health-data-conversion-to-fhir-observation by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Dec 2022 08:16:04 GMT -->
</html>
