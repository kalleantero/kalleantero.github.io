<!DOCTYPE html>
<html>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/experiences-about-finnish-personal-health-record-national-data-repository-part-3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 May 2022 11:55:06 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>

    <!--- basic page needs
    ================================================== -->
    <meta charset="utf-8">

    
    <title>Experiences about Finnish Personal Health Record national data repository (part 3) - Blog by Kalle Marjokorpi</title>
    <meta name="description" content="This blog post covers: How to implement a small client ASP.NET Core application which gets access token from PHR and How to use Postman to f">
    <meta name="author" content="Kalle Marjokorpi">


    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="../css/base51ab.css?dt=637880395044670835">
    <link rel="stylesheet" href="../css/vendor51ab.css?dt=637880395044670835">
    <link rel="stylesheet" href="../css/main51ab.css?dt=637880395044670835">
    <script src="../js/modernizr.js"></script>

</head>
<body id="top">
   
    <!-- header
    ================================================== -->

    <!-- header
   ================================================== -->

<header class="s-header">

    <div class="header-logo">
        <a class="site-logo" href="../index.html"><img src="../images/logo2.png" alt="Homepage"></a>
    </div>

    

    <nav class="header-nav-wrap">

        <ul class="header-nav">


            <li class=""><a id="top-navigation-link-root" href="../index.html" title="">Home</a></li>

                <li id="top-navigation-link-about" class="smoothscroll"><a href="../about.html" title="">About me</a></li>

        </ul>
    </nav> <!-- end main-nav-wrap -->




    <a class="header-menu-toggle" href="#0"><span>Menu</span></a>

</header> <!-- end s-header -->



    

<!-- content
   ================================================== -->


    <article class="blog-single">

        <!-- page header/blog hero
    ================================================== -->

        
        <div class="page-header page-header--single page-hero" style=background-image:url(https://cdn.buttercms.com/qGkHr87ATKV095KNVp6A)>

            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                                <a id="post-category-health-care" href="category/health-care.html">Health Care</a>
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        <a href="#0" title="">
                            Experiences about Finnish Personal Health Record data repository (part 3)
                        </a>
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">
26.10.2018 14:22                        </li>
                        <li class="author">
                            By
                            <span>Kalle Marjokorpi</span>
                        </li>
                    </ul>

                </article>
                
            </div>

        </div> <!-- end page-header -->

        <div class="row blog-content">
            <div class="col-full blog-content__main">

                <p><p>This blog post covers: How to implement a small ASP.NET Core application which redirects user to the PHR Sandbox server and retrieves access token from the PHR endpoint. This application is used to demonstrate OAuth 2 authorization code flow. Before creating this application read my <a href="https://devaaja.fi/blog/experiences-about-finnish-personal-health-record-national-data-repository-part-2">previous blog post</a> about PHR.</p>
<h2><span>Overview</span></h2>
<p><img src="https://cdn.buttercms.com/WAjyfOFR6Cy24TqqL7ZQ" alt="undefined" /></p>
<p></p>
<h2><span>User redirection to PHR authorization UI</span></h2>
<p><span>Application creates authorization redirection to PHR Sandbox Authorization UI with the following query string&nbsp;parameters:</span></p>
<table border="1" style="border-collapse: collapse; width: 45.5562%;" height="135">
<tbody>
<tr style="height: 46px;">
<td style="width: 21.8775%; height: 46px;"><strong>Parameter</strong></td>
<td style="width: 111.683%; height: 46px;"><strong>Description</strong></td>
</tr>
<tr style="height: 46px;">
<td style="width: 21.8775%; height: 46px;">
<p><span>response_type</span></p>
</td>
<td style="width: 111.683%; height: 46px;">
<p><span>Hard coded value "code"</span></p>
</td>
</tr>
<tr style="height: 46px;">
<td style="width: 21.8775%; height: 46px;">
<p><span>client_id</span></p>
</td>
<td style="width: 111.683%; height: 46px;">
<p><span>Client Id of your application</span></p>
</td>
</tr>
<tr style="height: 36px;">
<td style="width: 21.8775%; height: 36px;">
<p><span>redirect_uri </span></p>
</td>
<td style="width: 111.683%; height: 36px;">
<p><span>Client Application URL where user is redirected after authorization. This application will redirect user back to the following address&nbsp;https://localhost:44365/phr/authorization (PhrController)</span></p>
</td>
</tr>
<tr style="height: 36px;">
<td style="width: 21.8775%; height: 36px;">
<p><span>scope</span></p>
</td>
<td style="width: 111.683%; height: 36px;">
<p><span>Scopes which are required in the client application (ex. Observation read/write)</span></p>
</td>
</tr>
<tr style="height: 120px;">
<td style="width: 21.8775%; height: 120px;">
<p><span>state</span></p>
</td>
<td style="width: 111.683%; height: 120px;">
<p><span><span> State value generated by client application.&nbsp;During authentication, the application sends this parameter in the authorization request, and the Authorization Server will return this parameter unchanged in the response. State parameter is used to m</span></span>ake sure that the response belongs to a request that was initiated by the same user. Therefore,<span style="font-family: Lato, Helvetica, Arial, sans-serif; font-size: 1em;">&nbsp;</span>state<span style="font-family: Lato, Helvetica, Arial, sans-serif; font-size: 1em;">&nbsp;</span><span style="font-family: Lato, Helvetica, Arial, sans-serif; font-size: 1em;">helps mitigate</span><span style="font-family: Lato, Helvetica, Arial, sans-serif; font-size: 1em;">&nbsp;CSRF attacks. More information about state parameter can be find from <a href="https://auth0.com/docs/protocols/oauth2/oauth-state">here</a>&nbsp;(Auth0).</span></p>
<p><span style="font-family: Lato, Helvetica, Arial, sans-serif; font-size: 1em;">This sample application stores state value to the cookie.</span></p>
</td>
</tr>
</tbody>
</table>
<p><span><img src="https://cdn.buttercms.com/ant2Ya4uT8KX62IKBITQ" alt="" /></span><span></span></p>
<pre class="language-csharp"><code>public class HomeController : Controller
    {
        private readonly AppSettings _appSettings;

        public HomeController(IOptions&lt;AppSettings&gt; settings)
        {
            _appSettings = settings.Value;
        }
        public IActionResult Index()
        {
            return View();
        }

        public IActionResult PhrAuthorization()
        {
            var phrAuthServerUrl = _appSettings.PHRAuthServerUrl;
            var responseType = "code";
            var clientId = _appSettings.PHRClientId;
            var redirectUri = WebUtility.UrlEncode(_appSettings.PHRRedirectUrl);
            var scopes = WebUtility.UrlEncode(_appSettings.PHRScopes);
            //create a new state parameter per request
            var state = Guid.NewGuid().ToString();
            //set state value to the cookies which expires after 1 minute
            SetCookie(PHRConstants.AuthorizationStateCookie, state, 1);
            //create a redirect URL
            var redirectUrl = $"{phrAuthServerUrl}?response_type={responseType}&amp;client_id={clientId}&amp;redirect_uri={redirectUri}&amp;scope={scopes}&amp;state={state}";
            //redirect user to the PHR
            return Redirect(redirectUrl);
        }

        /// &lt;summary&gt;  
        /// set the cookie  
        /// &lt;/summary&gt;  
        /// &lt;param name="key"&gt;key (unique indentifier)&lt;/param&gt;  
        /// &lt;param name="value"&gt;value to store in cookie object&lt;/param&gt;  
        /// &lt;param name="expireTime"&gt;expiration time&lt;/param&gt;  
        public void SetCookie(string key, string value, int? expireTime)
        {
            CookieOptions option = new CookieOptions();

            if (expireTime.HasValue)
                option.Expires = DateTime.Now.AddMinutes(expireTime.Value);
            else
                option.Expires = DateTime.Now.AddMilliseconds(10);

            Response.Cookies.Append(key, value, option);
        }
    }</code></pre>
<h3><span>Authorization views in the PHR Sandbox</span></h3>
<p>The following login view is shown after redirection in the PHR Sandbox service. In the login phase user inputs first name, last name and Finnish social security number. When testing a service you can generate Finnish social security numbers from <a href="http://www.lintukoto.net/muut/henkilotunnus/index.php">here</a>.&nbsp;In the production and QA-environment (aka. AT-test) login will be handled via Suomi.fi.</p>
<p><img src="https://cdn.buttercms.com/WIYd8hQStfDjtcZeWzQI" alt="" /></p>
<p>After login user can give or refuse the permissions which were declared in the application settings and scopes. This application uses only Observation data.</p>
<p><span><img src="https://cdn.buttercms.com/OWgJQv9lTXa9YLIoS7oM" alt="" /></span></p>
<h3><span></span>Handling of authorization code and access token</h3>
<p>PHR Controller is used in this application to receive an authorization code and get access token after user has given the permission in the PHR Authorization UI. PHR Controller uses service called PHRSandboxService to communicate with PHR Token endpoint. <span>After approval or refusal in PHR Authorization UI user will be redirect to the address which was declared in the authorization url (redirect URL). If user has approved the permissions then authorization code will be passed to the redirect url with code-parameter.</span></p>
<p>Authorization action gets the authorization code and state values as a query string parameters. Action checks that state parameter equals with the same value which was stored to the cookie before user was redirected to the PHR Authorization service. If state value is missing or not match then operation will be canceled.&nbsp;</p>
<pre class="language-csharp"><code>public class PHRController : Controller
    {
        private readonly IPHRSandboxService _phrSandboxService;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private readonly AppSettings _appSettings;

        public PHRController(IPHRSandboxService phrSandboxService, IHttpContextAccessor httpContextAccessor, IOptions&lt;AppSettings&gt; settings)
        {
            _phrSandboxService = phrSandboxService;
            _httpContextAccessor = httpContextAccessor;
            _appSettings = settings.Value;
        }

        public async Task&lt;IActionResult&gt; Authorization(string code, string state)
        {
            if (string.IsNullOrEmpty(code) || string.IsNullOrEmpty(state))
                throw new Exception("Authorization state or code was null or empty");

            //get state parameter from the cookie
            string authorizationStateCookie = _httpContextAccessor.HttpContext.Request.Cookies[PHRConstants.AuthorizationStateCookie];

            if (string.IsNullOrEmpty(authorizationStateCookie))
                throw new Exception("Authorization state in the cookie was null");

            if (!state.Equals(authorizationStateCookie))
                throw new Exception("Authorization states not matched");

            var parameters = new PHRTokenRequestParams() {
                Client_id = _appSettings.PHRClientId,
                Code = code,
                Grant_type = "authorization_code",
                Redirect_uri = _appSettings.PHRRedirectUrl
            };

            var data = await _phrSandboxService.GetTokenResponse(parameters);

            return View(data);
        }
    }</code></pre>
<h3><span>PHR Sandbox Service class</span></h3>
<p><span>This class handles all HTTP request to the PHR Authorization server.&nbsp;</span></p>
<p><span>Service implements the following interface:</span></p>
<pre class="language-csharp"><code>public interface IPHRSandboxService
    {
        Uri AuthApiBaseUri { get; set; }
        Uri TokenApiBaseUri { get; set; }
        Task&lt;PHRTokenResponse&gt; GetTokenResponse(PHRTokenRequestParams requestParams);
    }</code></pre>
<p>This service class communicates with PHR Sandbox service end points (in this phase only Token endpoint is implemented). Client certificate is not required to use in Sandbox environment. Basic authentication header should be added to the request otherwise you will receive 401 unauthorized. Basic authentication header value is a combination of your ClientId and Client secret.&nbsp;</p>
<pre class="language-csharp"><code> public class PHRSandboxService : IPHRSandboxService
    {
        private readonly IHttpClientFactory _clientFactory;
        private readonly AppSettings _appSettings;

        public Uri AuthApiBaseUri { get; set; }
        public Uri TokenApiBaseUri { get; set; }

        public PHRSandboxService(IOptions&lt;AppSettings&gt; settings, IHttpContextAccessor httpContextAccessor, IHttpClientFactory clientFactory)
        {
            //Sandbox uses one url for auth and token endpoint
            TokenApiBaseUri = new Uri(settings.Value.PHRTokenApiUrl + (settings.Value.PHRTokenApiUrl.EndsWith("/") ? "" : "/"));
            _appSettings = settings.Value;
            _clientFactory = clientFactory;
        }

        public async Task&lt;PHRTokenResponse&gt; GetTokenResponse(PHRTokenRequestParams requestParams)
        {
            string url = $"token";
            string stringcont = $"grant_type={WebUtility.UrlEncode(requestParams.Grant_type)}&amp;code={WebUtility.UrlEncode(requestParams.Code)}&amp;redirect_uri={WebUtility.UrlEncode(requestParams.Redirect_uri)}&amp;client_id={WebUtility.UrlEncode(requestParams.Client_id)}";
            var content = new StringContent(stringcont, Encoding.UTF8, "application/x-www-form-urlencoded");
            var response = await CreateTokenSendRequest(HttpMethod.Post, url, content);
            response.EnsureSuccessStatusCode();
            var stringResponse = await response.Content.ReadAsStringAsync();
            var tokenResponse = JsonConvert.DeserializeObject&lt;PHRTokenResponse&gt;(stringResponse);

            return tokenResponse;
        }


        private async Task&lt;HttpResponseMessage&gt; CreateTokenSendRequest(HttpMethod method, string uri, StringContent content = null)
        {
            var request = new HttpRequestMessage(method, new Uri(TokenApiBaseUri + uri));
            request.Headers.Authorization = new AuthenticationHeaderValue("Basic", Convert.ToBase64String(System.Text.ASCIIEncoding.ASCII.GetBytes(string.Format("{0}:{1}", _appSettings.PHRClientId, _appSettings.PHRClientSecret))));
            if (content != null)
            {
                request.Content = content;
            }

            var _httpClient = _clientFactory.CreateClient();

            var response = await _httpClient.SendAsync(request);
            return response;
        }
    }</code></pre>
<p>Now application has authorized user and can communicate with PHR resource endpoint by using the access token.</p>
<p></p></p>

                <h2>Comments</h2>
                                    
                <div id="cusdis_thread"
                  data-host="https://cusdis.com/"
                  data-app-id="86620953-7757-4f01-94f2-bfb88caff8a4"
                  data-page-id="experiences-about-finnish-personal-health-record-national-data-repository-part-3"
                  data-page-url="experiences-about-finnish-personal-health-record-national-data-repository-part-3.html"
                  data-page-title="Experiences about Finnish Personal Health Record data repository (part 3)">
                <script src="https://cusdis.com/js/cusdis.es.js"></script>

                <div class="blog-content__pagenav">
                    <div class="blog-content__nav">
                            <div class="blog-content__prev">
                                <a id="post-previous-experiences-about-finnish-personal-health-record-national-data-repository-part-2" href="experiences-about-finnish-personal-health-record-national-data-repository-part-2.html" rel="prev">
                                    <span>Previous Post</span>
                                    Experiences about Finnish Personal Health Record data repository (part 2)
                                </a>
                            </div>
                            <div class="blog-content__next">
                                <a id="post-next-how-to-export-exercise-data-from-movescount-and-sports-tracker" href="how-to-export-exercise-data-from-movescount-and-sports-tracker.html" rel="next">
                                    <span>Next Post</span>
                                    How to export exercise data from Movescount and Sports Tracker
                                </a>
                            </div>
                        </div>


                    <div class="blog-content__all">
                        <a href="../index.html" class="btn btn--primary">
                            View All Post
                        </a>
                    </div>
                </div>

            </div><!-- end blog-content__main -->
        </div> <!-- end blog-content -->

    </article>



    

<!-- footer
    ================================================== -->
<footer>
    <div class="row">
        <div class="col-full">

            <div class="footer-logo">
                <a class="footer-site-logo" href="#0"><img src="../images/name.png" alt="Homepage"></a>
            </div>

            <ul class="footer-social">
                <li>
                    <a href="https://www.twitter.com/kmarjok">
                        <i class="im im-twitter" aria-hidden="true"></i>
                        <span>Twitter</span>
                    </a>
                </li>
                <li>
                    <a href="https://www.linkedin.com/in/kallemarjokorpi">
                        <i class="im im-linkedin" aria-hidden="true"></i>
                        <span>Linkedin</span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/kalleantero">
                        <i class="im im-github" aria-hidden="true"></i>
                        <span>Github</span>
                    </a>
                </li>
            </ul>

        </div>
    </div>

    <div class="row footer-bottom">

        <div class="col-twelve">
            <div class="copyright">
                <span>Copyright Kalle Marjokorpi 2022</span>
                <span>Design by <a href="http://www.styleshout.com/">styleshout</a></span>
                <span>Content management by <a href="http://www.buttercms.com/">Headless ButterCMS</a></span>

            </div>

        </div>

    </div> <!-- end footer-bottom -->

</footer> <!-- end footer -->
   
    <!-- Java Script
     ================================================== -->

    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/plugins.js"></script>
    <script src="../js/main.min.js"></script>
    
    
    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "cac9fd24c1c04b6d9984ea31685b0414"}'></script><!-- End Cloudflare Web Analytics -->       

</body>

<!-- Mirrored from kalle-blog.azurewebsites.net/blog/experiences-about-finnish-personal-health-record-national-data-repository-part-3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 May 2022 11:55:06 GMT -->
</html>
